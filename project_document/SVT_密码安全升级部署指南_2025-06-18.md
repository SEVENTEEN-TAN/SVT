# SVT 密码安全升级部署指南

**文档版本**: v1.0  
**创建时间**: 2025-06-18 14:54:00 +08:00  
**适用版本**: SVT v1.0.1+  

## 🎯 概述

本指南详细说明如何部署SVT系统的密码安全升级，包括：
1. Jasypt配置文件加密部署
2. Argon2密码哈希升级部署
3. 环境变量配置要求
4. 验证和测试步骤

## 📋 部署前准备

### 1. 环境要求
- Java 21+
- Spring Boot 3.3.2+
- 已完成代码更新和编译

### 2. 备份要求
- 备份现有配置文件
- 备份用户密码数据（如需要）
- 记录现有环境变量配置

## 🔐 Jasypt配置文件加密部署

### 1. 设置Jasypt加密密钥

**生产环境**：
```bash
export JASYPT_ENCRYPTOR_PASSWORD="your_strong_jasypt_key_here"
```

**开发环境**：
```bash
export JASYPT_ENCRYPTOR_PASSWORD="SVT_JASYPT_KEY_2025"
```

⚠️ **安全要求**：
- 生产环境密钥长度至少32位
- 包含大小写字母、数字、特殊字符
- 不要在代码或配置文件中硬编码
- 定期轮换密钥

### 2. 生成加密配置值

使用提供的测试工具生成加密值：

```bash
# 运行加密测试
cd SVT-Server
mvn test -Dtest=JasyptEncryptionTest#encryptSingleValue
```

或使用命令行工具：
```bash
java -cp jasypt-1.9.3.jar org.jasypt.intf.cli.JasyptPBEStringEncryptionCLI \
  input="your_secret_value" \
  password="your_jasypt_key" \
  algorithm=PBEWITHHMACSHA512ANDAES_256
```

### 3. 更新配置文件

将敏感配置替换为加密值：

**application-prod.yml 示例**：
```yaml
spring:
  datasource:
    url: jdbc:sqlserver://localhost:1433;databaseName=svt_db
    username: svt_user
    password: ENC(加密后的数据库密码)
  
  data:
    redis:
      host: localhost
      port: 6379
      password: ENC(加密后的Redis密码)
      database: 0

jwt:
  secret: ENC(加密后的JWT密钥)
  expiration: 86400

svt:
  security:
    aes:
      key: ENC(加密后的AES密钥)
```

## 🔒 Argon2密码哈希升级部署

### 1. 数据库密码更新策略

由于直接替换了SM4编码器，现有用户需要重新设置密码：

**选项A：批量重置（推荐）**
```sql
-- 将所有用户密码重置为临时密码
UPDATE user_info 
SET password = '$argon2id$v=19$m=4096,t=3,p=1$随机盐值$哈希值'
WHERE status = '0';

-- 通知用户重新设置密码
```

**选项B：首次登录强制重置**
- 保留现有SM4密码
- 用户首次登录时强制重置
- 需要实现混合验证逻辑（如果选择此方案）

### 2. 验证Argon2配置

确认Argon2参数符合安全要求：
- **内存使用**: 4096 KB
- **迭代次数**: 3次
- **并行度**: 1
- **盐值长度**: 16字节
- **哈希长度**: 32字节

## 🚀 部署步骤

### 1. 停止应用服务
```bash
# 停止SVT应用
systemctl stop svt-service
# 或
kill -TERM $(cat svt.pid)
```

### 2. 更新应用代码
```bash
# 部署新版本
cp SVT-Server-1.0.1.jar /opt/svt/
```

### 3. 配置环境变量
```bash
# 设置Jasypt密钥
export JASYPT_ENCRYPTOR_PASSWORD="your_production_key"

# 验证环境变量
echo $JASYPT_ENCRYPTOR_PASSWORD
```

### 4. 更新配置文件
```bash
# 备份原配置
cp application-prod.yml application-prod.yml.backup

# 部署新配置（包含加密值）
cp application-prod-encrypted.yml application-prod.yml
```

### 5. 启动应用验证
```bash
# 启动应用
java -jar SVT-Server-1.0.1.jar --spring.profiles.active=prod

# 检查启动日志
tail -f logs/system.log
```

## ✅ 验证测试

### 1. 配置文件加密验证

**测试步骤**：
```bash
# 1. 验证应用正常启动
curl http://localhost:8080/api/health

# 2. 验证数据库连接
curl http://localhost:8080/api/system/test/db

# 3. 验证Redis连接  
curl http://localhost:8080/api/system/test/redis
```

**预期结果**：
- 应用正常启动，无配置解密错误
- 数据库连接正常
- Redis连接正常

### 2. Argon2密码验证

**测试步骤**：
```bash
# 1. 注册新用户
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"Test123!"}'

# 2. 登录验证
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"loginId":"test","password":"Test123!"}'
```

**预期结果**：
- 新用户注册成功
- 密码使用Argon2哈希存储
- 登录验证正常

### 3. 数据库密码格式验证

```sql
-- 检查新密码格式
SELECT user_id, username, 
       CASE 
         WHEN password LIKE '$argon2id$%' THEN 'Argon2'
         ELSE 'Legacy'
       END as password_type
FROM user_info
LIMIT 10;
```

## 🔧 故障排除

### 常见问题

**1. Jasypt解密失败**
```
错误：Unable to decrypt property
解决：检查JASYPT_ENCRYPTOR_PASSWORD环境变量是否正确设置
```

**2. Argon2密码验证失败**
```
错误：Bad credentials
解决：确认用户密码已更新为Argon2格式
```

**3. 应用启动失败**
```
错误：Failed to configure a DataSource
解决：验证加密后的数据库配置是否正确
```

### 回滚方案

如果部署出现问题，可以快速回滚：

```bash
# 1. 停止应用
systemctl stop svt-service

# 2. 恢复原配置
cp application-prod.yml.backup application-prod.yml

# 3. 部署原版本
cp SVT-Server-1.0.0.jar /opt/svt/SVT-Server.jar

# 4. 启动应用
systemctl start svt-service
```

## 📊 监控和维护

### 1. 日志监控
```bash
# 监控加密相关错误
grep -i "jasypt\|encrypt\|decrypt" logs/system.log

# 监控密码验证错误  
grep -i "argon2\|password" logs/system.log
```

### 2. 性能监控
- 监控Argon2密码验证性能
- 如果性能影响显著，可调整参数

### 3. 安全审计
- 定期检查密钥安全性
- 监控异常登录尝试
- 定期轮换Jasypt密钥

## 📝 注意事项

1. **密钥管理**：Jasypt密钥是系统安全的关键，务必妥善保管
2. **密码迁移**：现有用户需要重新设置密码
3. **性能影响**：Argon2比SM4计算开销更大，但安全性显著提升
4. **备份策略**：确保配置文件和密钥的安全备份
5. **监控告警**：建议配置相关的监控告警

---

**文档维护**：本文档应随系统升级及时更新  
**技术支持**：如有问题请联系系统管理员 