# SVT JWTæœ¬åœ°ç¼“å­˜æ¶æ„è¯´æ˜

**é¡¹ç›®ID**: SVT-Management-System  
**æ–‡æ¡£åç§°**: SVT_JWTæœ¬åœ°ç¼“å­˜æ¶æ„è¯´æ˜_2025-06-20.md  
**åˆ›å»ºæ—¶é—´**: 2025-06-20 16:05:59 +08:00  
**åˆ›å»ºè€…**: SEVENTEEN (AI Assistant)  
**å…³è”åè®®**: RIPER-5 v4.1

## ğŸ“‹ **æ¶æ„æ¦‚è¿°**

### ğŸ—ï¸ **è®¾è®¡åŸåˆ™**

SVTé‡‡ç”¨çš„JWTæœ¬åœ°ç¼“å­˜æ¶æ„éµå¾ªä»¥ä¸‹è®¾è®¡åŸåˆ™ï¼š
- **å®‰å…¨ç¬¬ä¸€**: æœåŠ¡é‡å¯åå¼ºåˆ¶é‡æ–°ç™»å½•
- **é«˜æ€§èƒ½**: æœ¬åœ°ç¼“å­˜é¿å…ç½‘ç»œå»¶è¿Ÿ
- **ç®€å•å¯é **: é¿å…åˆ†å¸ƒå¼ç¼“å­˜å¤æ‚æ€§
- **Session Sticky**: ç”¨æˆ·è¯·æ±‚å›ºå®šè·¯ç”±åˆ°åŒä¸€å®ä¾‹

## ğŸ”’ **å®‰å…¨ç­–ç•¥**

### **æ ¸å¿ƒå®‰å…¨æœºåˆ¶**

**4å±‚å®‰å…¨éªŒè¯**:
1. âœ… **é»‘åå•æ£€æŸ¥**: æ£€æŸ¥Tokenæ˜¯å¦å·²è¢«æ‹‰é»‘
2. âœ… **ç¼“å­˜å­˜åœ¨æ£€æŸ¥**: JWTå¿…é¡»åœ¨æœ¬åœ°ç¼“å­˜ä¸­å­˜åœ¨
3. âœ… **IPä¸€è‡´æ€§æ£€æŸ¥**: é˜²æ­¢Tokenè¢«å…¶ä»–IPç›—ç”¨
4. âœ… **Tokenä¸€è‡´æ€§æ£€æŸ¥**: é˜²æ­¢Tokenè¢«ç¯¡æ”¹æˆ–å¤ç”¨

**æœåŠ¡é‡å¯å®‰å…¨ç­–ç•¥**:
```java
// æ­£ç¡®çš„å®‰å…¨é€»è¾‘
JwtCache existingCache = jwtCacheUtils.getJwt(loginId);
if (existingCache == null) {
    // ç¼“å­˜ä¸å­˜åœ¨ = è®¤è¯å¤±è´¥
    // è¿™æ˜¯FEATUREï¼Œä¸æ˜¯BUGï¼
    throw new BusinessException("è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•");
}
```

## ğŸ”„ **ç”¨æˆ·ä½“éªŒæµç¨‹**

### **æ­£å¸¸å·¥ä½œæµç¨‹**

**åˆæ¬¡ç™»å½•**:
1. ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç  â†’ åç«¯éªŒè¯ âœ…
2. åç«¯ç”ŸæˆJWT â†’ åˆ›å»ºæœ¬åœ°ç¼“å­˜ âœ…
3. å‰ç«¯ä¿å­˜Token â†’ è·³è½¬Dashboard âœ…
4. åç»­APIè¯·æ±‚ â†’ ç¼“å­˜éªŒè¯é€šè¿‡ âœ…

**æœåŠ¡é‡å¯åœºæ™¯**:
1. æœåŠ¡é‡å¯ â†’ æœ¬åœ°ç¼“å­˜æ¸…ç©º âœ…
2. å‰ç«¯ä»æœ‰Token â†’ è‡ªåŠ¨è·³è½¬Dashboard â“
3. Dashboardå‘é€APIè¯·æ±‚ â†’ åç«¯401é”™è¯¯ âœ…
4. å‰ç«¯æ£€æµ‹401 â†’ æ¸…é™¤Tokenï¼Œè·³è½¬ç™»å½•é¡µ âœ…

### **å½“å‰è¡Œä¸ºåˆ†æ**

**ç”¨æˆ·çœ‹åˆ°çš„ç°è±¡**:
```
1. ç™»å½•æˆåŠŸ â†’ Dashboardæ­£å¸¸ä½¿ç”¨ âœ…
2. æœåŠ¡é‡å¯
3. è®¿é—®å‰ç«¯ â†’ è‡ªåŠ¨è·³è½¬Dashboard â“
4. Dashboardç™½å±æˆ–é”™è¯¯ âŒ
```

**æŠ€æœ¯åˆ†æ**:
- å‰ç«¯`ProtectedRoute`åªæ£€æŸ¥localStorageï¼Œä¸éªŒè¯åç«¯çŠ¶æ€
- Dashboardç»„ä»¶åŠ è½½æ—¶å‘é€APIè¯·æ±‚æ‰ä¼šè§¦å‘401é”™è¯¯
- å­˜åœ¨ç”¨æˆ·ä½“éªŒçš„æ—¶é—´å·®

## ğŸ› ï¸ **æ¶æ„ä¼˜åŒ–å»ºè®®**

### **å½“å‰æ¶æ„æƒè¡¡**

| æ–¹æ¡ˆ | ç”¨æˆ·ä½“éªŒ | å®‰å…¨æ€§ | å¤æ‚åº¦ | æ¨èåº¦ |
|------|----------|--------|--------|--------|
| **å½“å‰æ–¹æ¡ˆ**: æœ¬åœ°ç¼“å­˜+é‡å¯é‡ç™» | B+ | ğŸ”’ A+ | ä½ | âœ… é€‚åˆå½“å‰ |
| **å‰ç«¯æ”¹è¿›**: é¦–é¡µTokenéªŒè¯ | A- | ğŸ”’ A+ | ä¸­ | ğŸ”§ å¯ä¼˜åŒ– |
| **åˆ†å¸ƒå¼ç¼“å­˜**: Rediså…±äº« | A+ | B+ | é«˜ | ğŸ”„ æœªæ¥è€ƒè™‘ |

### **å‰ç«¯ä¼˜åŒ–æ–¹æ¡ˆ**

**æ–¹æ¡ˆA: Dashboardé¦–é¡µTokenéªŒè¯**
```typescript
// åœ¨Dashboardç»„ä»¶åŠ è½½æ—¶ç«‹å³éªŒè¯Token
useEffect(() => {
  const verifyToken = async () => {
    try {
      // å‘é€ä¸€ä¸ªè½»é‡çº§APIè¯·æ±‚éªŒè¯Token
      await api.get('/api/auth/verify');
    } catch {
      // Tokenæ— æ•ˆï¼Œç«‹å³è·³è½¬ç™»å½•
      authStore.logout();
      navigate('/login');
    }
  };
  verifyToken();
}, []);
```

**æ–¹æ¡ˆB: ProtectedRouteæ”¹è¿›**
```typescript
// åœ¨è·¯ç”±å®ˆå«ä¸­ä¸»åŠ¨éªŒè¯Tokenæœ‰æ•ˆæ€§
const ProtectedRoute = ({ children }) => {
  const [tokenValid, setTokenValid] = useState(null);
  
  useEffect(() => {
    const checkToken = async () => {
      if (!token) {
        setTokenValid(false);
        return;
      }
      
      try {
        await api.get('/api/auth/verify');
        setTokenValid(true);
      } catch {
        setTokenValid(false);
        authStore.logout();
      }
    };
    
    checkToken();
  }, []);
  
  if (tokenValid === false) {
    return <Navigate to="/login" />;
  }
  
  return children;
};
```

## ğŸ“Š **æ€§èƒ½ä¸å®‰å…¨å¯¹æ¯”**

### **æ¶æ„æ€§èƒ½åˆ†æ**

**æœ¬åœ°ç¼“å­˜æ€§èƒ½**:
- JWTéªŒè¯å»¶è¿Ÿ: <1ms
- å†…å­˜å ç”¨: æä½
- ç½‘ç»œå¼€é”€: 0

**åˆ†å¸ƒå¼ç¼“å­˜æ€§èƒ½**:
- JWTéªŒè¯å»¶è¿Ÿ: 1-5ms
- å†…å­˜å ç”¨: ä¸­ç­‰
- ç½‘ç»œå¼€é”€: æ¯æ¬¡è¯·æ±‚

### **å®‰å…¨æ€§åˆ†æ**

**æœ¬åœ°ç¼“å­˜å®‰å…¨ä¼˜åŠ¿**:
- âœ… æœåŠ¡é‡å¯è‡ªåŠ¨æ¸…ç†ä¼šè¯
- âœ… æ— åˆ†å¸ƒå¼ä¸€è‡´æ€§é£é™©
- âœ… IPç»‘å®šå‡†ç¡®å¯é 
- âœ… ç®€å•æ¶æ„ï¼Œå®‰å…¨å¯æ§

**æ½œåœ¨é£é™©**:
- â“ è´Ÿè½½å‡è¡¡é…ç½®ä¾èµ–(Session Sticky)
- â“ æœåŠ¡é‡å¯å½±å“ç”¨æˆ·ä½“éªŒ

## ğŸ¯ **ç»“è®ºä¸å»ºè®®**

### **å½“å‰æ¶æ„è¯„ä¼°**

**ä¼˜åŠ¿**:
- âœ… å®‰å…¨æ€§A+çº§åˆ«
- âœ… æ€§èƒ½ä¼˜ç§€
- âœ… æ¶æ„ç®€å•å¯é 
- âœ… é€‚åˆå•ä½“åº”ç”¨

**å¯ä¼˜åŒ–ç‚¹**:
- ğŸ”§ å‰ç«¯TokenéªŒè¯æ—¶æœºä¼˜åŒ–
- ğŸ”§ ç”¨æˆ·ä½“éªŒæå‡

### **å‘å±•è·¯å¾„**

**çŸ­æœŸä¼˜åŒ–** (å½“å‰é˜¶æ®µ):
- æ”¹è¿›å‰ç«¯TokenéªŒè¯é€»è¾‘
- ä¼˜åŒ–ç”¨æˆ·ä½“éªŒæµç¨‹

**ä¸­æœŸæ¼”è¿›** (ä¸šåŠ¡æ‰©å±•):
- è€ƒè™‘åˆ†å¸ƒå¼ç¼“å­˜æ–¹æ¡ˆ
- å¾®æœåŠ¡æ¶æ„å‡†å¤‡

**é•¿æœŸè§„åˆ’** (ä¼ä¸šçº§):
- ç‹¬ç«‹è®¤è¯æœåŠ¡
- å¤šç§Ÿæˆ·æ”¯æŒ

## ğŸ” **å…³é”®ç†è§£**

### **é‡è¦è§‚å¿µè½¬å˜**

**é”™è¯¯ç†è§£**:
âŒ "æœåŠ¡é‡å¯åTokenè¿˜èƒ½ç”¨æ˜¯æ­£å¸¸çš„"
âŒ "åº”è¯¥é‡å»ºç¼“å­˜è®©ç”¨æˆ·ç»§ç»­ä½¿ç”¨"

**æ­£ç¡®ç†è§£**:
âœ… "æœåŠ¡é‡å¯åå¼ºåˆ¶é‡ç™»æ˜¯å®‰å…¨ç­–ç•¥"
âœ… "æœ¬åœ°ç¼“å­˜ä¸¢å¤± = ä¼šè¯å¤±æ•ˆ"

**è¿™ä¸æ˜¯Bugï¼Œè¿™æ˜¯Featureï¼**

æœåŠ¡é‡å¯åç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•æ˜¯åˆç†çš„å®‰å…¨ç­–ç•¥ï¼Œç‰¹åˆ«æ˜¯åœ¨ä»¥ä¸‹åœºæ™¯ï¼š
- ç³»ç»Ÿæ›´æ–°éƒ¨ç½²
- å®‰å…¨è¡¥ä¸åº”ç”¨
- åº”æ€¥æ•…éšœæ¢å¤

è¿™ç¡®ä¿äº†ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œä¼šè¯çŠ¶æ€çš„å¯é æ€§ã€‚

## ğŸ“ **æ€»ç»“**

SVTçš„JWTæœ¬åœ°ç¼“å­˜æ¶æ„æ˜¯ä¸€ä¸ª**å®‰å…¨ä¼˜å…ˆ**çš„è®¾è®¡ï¼Œåœ¨å•ä½“åº”ç”¨åœºæ™¯ä¸‹æä¾›äº†æœ€ä½³çš„æ€§èƒ½å’Œå®‰å…¨æ€§å¹³è¡¡ã€‚å½“å‰çš„"æœåŠ¡é‡å¯åéœ€è¦é‡æ–°ç™»å½•"æ˜¯æ­£ç¡®çš„å®‰å…¨è¡Œä¸ºï¼Œé€šè¿‡å‰ç«¯ä¼˜åŒ–å¯ä»¥è¿›ä¸€æ­¥æå‡ç”¨æˆ·ä½“éªŒã€‚ 