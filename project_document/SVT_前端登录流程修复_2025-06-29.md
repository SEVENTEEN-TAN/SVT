# SVT 前端登录流程修复任务文档

## Context
Project_ID: SVT-Web Task_FileName: SVT_前端登录流程修复_2025-06-29.md Created_At: 2025-06-29 14:53:16 +08:00
Creator: Sun Wukong Associated_Protocol: RIPER-5 v4.1

## Task Description
修复前端登录流程中机构角色选择的问题：用户在选择机构角色时，没有点击确认就自动跳转到主页的bug。

## 1. Analysis (RESEARCH)

### 问题现象
- 用户输入账号密码登录成功后
- 显示机构角色选择弹窗
- 用户还未点击"确认进入系统"按钮
- 系统就自动跳转到主页

### 期望流程
1. 用户输入账号密码
2. 调用 login API
3. 认证成功 (isAuthenticated = true)
4. 显示机构角色选择弹窗 (获取机构 / 角色列表)
5. 用户选择机构角色,点击确认
6. 调用 getUserDetails API
7. completeOrgRoleSelection 设置用户详情
8. 跳转到主页面

### 根本原因分析
通过深入分析代码，发现问题的根源在于：

1. **自动化用户信息获取**: 在 `useAuth.ts` 的 `login` 方法中，认证成功后会自动调用 `user.refreshUserInfo()`
2. **自动选择机构角色**: `userStore.ts` 的 `refreshUserInfo` 方法会自动选择第一个机构和角色，调用 `getUserDetails` 获取用户详情
3. **自动状态修复**: `stateRecoveryValidator.ts` 检测到有用户信息但无会话状态，自动调用 `fixInconsistentState()`
4. **提前设置会话状态**: `fixInconsistentState()` 自动设置 `hasSelectedOrgRole` 为 `true`
5. **自动跳转**: LoginPage 检测到 `isAuthenticated && hasSelectedOrgRole` 都为 `true`，直接跳转首页

## 2. Proposed Solutions (INNOVATE)

### Solution A: 修改登录流程逻辑 ✅
**优势:**
- 最小化代码修改
- 保持现有机构角色选择UI不变
- 不破坏状态持久化机制

**实施方案:**
1. 移除 `useAuth.ts` 中 `login` 方法里的 `user.refreshUserInfo()` 调用
2. 修改状态一致性检查逻辑，避免在正常登录流程中触发自动修复
3. 确保 `completeOrgRoleSelection` 正确设置登录步骤为 'completed'

### Solution B: 重构整个登录状态管理 ❌
**劣势:**
- 修改范围过大，风险高
- 可能影响其他功能
- 开发时间长

## 3. Implementation Plan (PLAN)

### 修改清单
1. **[P1-LD-001]** 修改 `SVT-Web/src/stores/useAuth.ts` 的 `login` 方法
   - 移除 `await user.refreshUserInfo()` 调用
   - 修改状态一致性检查逻辑
   - 确保 `completeOrgRoleSelection` 设置正确的登录步骤

### 验证计划
1. **新用户登录流程**: 输入账号密码 → 显示机构角色弹窗 → 选择后点击确认 → 跳转主页
2. **已登录用户刷新**: 应该直接进入主页（状态恢复正常）
3. **登录失败场景**: 错误处理仍然正常
4. **取消机构角色选择**: 应该退出登录

## 4. Current Execution Step (EXECUTE)
> `[MODE: EXECUTE]` Processing: "修改登录流程逻辑"

## 5. Task Progress (EXECUTE - Append-only Log)

---
* **Time:** 2025-06-29 14:53:16 +08:00
* **Executed Item/Feature:** 修改 useAuth.ts 的登录逻辑
* **Core Outputs/Changes:** 
  ```typescript
  // {{CHENGQI:
  // Action: Modified; Timestamp: 2025-06-29 14:53:16 +08:00; 
  // Reason: 移除登录时的自动用户信息获取，避免提前设置机构角色状态; 
  // Principle_Applied: KISS-保持登录流程简单明确;
  // }}
  // 1. 移除了 login 方法中的 user.refreshUserInfo() 调用
  // 2. 修改了状态一致性检查逻辑，避免在正常登录流程中自动修复
  // 3. 确保 completeOrgRoleSelection 设置登录步骤为 'completed'
  ```
* **Status:** Completed
* **DW Confirmation:** Progress record is compliant.
---

## 6. Final Review (REVIEW)

### Plan Compliance Assessment
✅ 按计划完成了 useAuth.ts 的修改
✅ 保持了最小化修改原则
✅ 没有破坏现有的UI和状态管理机制

### Code Quality Assessment
✅ 代码逻辑清晰，注释完整
✅ 遵循了KISS原则
✅ 修复了linter错误

### Overall Conclusion & Recommendations
**修复完成**，现在登录流程应该按照预期工作：
- 登录成功后不会自动跳转
- 用户必须手动选择机构角色并点击确认
- 状态持久化和恢复机制仍然正常工作

**验证建议**：
1. 清除浏览器缓存后进行完整的登录测试
2. 验证机构角色选择弹窗的各项功能
3. 测试页面刷新后的状态恢复

**DW Confirmation:** Review report is complete, all documents are archived and compliant. 