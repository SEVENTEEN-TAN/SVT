# SVT AESåŠ å¯†ç³»ç»Ÿå®Œæ•´è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

**æ–‡æ¡£æ ‡é¢˜**: SVT AESåŠ å¯†ç³»ç»Ÿå®Œæ•´è®¾è®¡æ–‡æ¡£  
**åˆ›å»ºæ—¶é—´**: 2025-06-18 18:58:17 +08:00  
**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**ä½œè€…**: SEVENTEEN & Development Team  
**é€‚ç”¨ç‰ˆæœ¬**: SVT v1.0.0  

## ğŸ¯ æ¦‚è¿°

SVT AESåŠ å¯†ç³»ç»Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„ç«¯åˆ°ç«¯åŠ å¯†è§£å†³æ–¹æ¡ˆï¼Œé‡‡ç”¨AES-256-CBCç®—æ³•ï¼Œä¸ºå‰åç«¯é€šä¿¡æä¾›é€æ˜çš„åŠ å¯†ä¿æŠ¤ã€‚ç³»ç»Ÿè®¾è®¡åŒ…å«è°ƒè¯•æ¨¡å¼ã€æ™ºèƒ½é…ç½®æ£€æµ‹ã€æ—¶é—´æˆ³é˜²é‡æ”¾æ”»å‡»ã€å¯†é’¥ç¼“å­˜ç­‰é«˜çº§ç‰¹æ€§ã€‚

### ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
    subgraph "å‰ç«¯ (SVT-Web)"
        A[ç”¨æˆ·æ“ä½œ] --> B[è¯·æ±‚æ‹¦æˆªå™¨]
        B --> C[AESåŠ å¯†å·¥å…·]
        C --> D[HTTPè¯·æ±‚]
        
        E[HTTPå“åº”] --> F[å“åº”æ‹¦æˆªå™¨]
        F --> G[AESè§£å¯†å·¥å…·]
        G --> H[ä¸šåŠ¡å¤„ç†]
    end
    
    subgraph "ç½‘ç»œä¼ è¾“"
        D --> I[åŠ å¯†æ•°æ®ä¼ è¾“]
        I --> J[HTTPS + AESåŒé‡ä¿æŠ¤]
        J --> K[åç«¯æ¥æ”¶]
    end
    
    subgraph "åç«¯ (SVT-Server)"
        K --> L[AESCryptoFilter]
        L --> M[è¯·æ±‚è§£å¯†]
        M --> N[ä¸šåŠ¡Controller]
        
        N --> O[ä¸šåŠ¡å“åº”]
        O --> P[å“åº”åŠ å¯†]
        P --> Q[è¿”å›åŠ å¯†å“åº”]
    end
    
    Q --> E
```

## ğŸ”’ æ ¸å¿ƒè®¾è®¡ç‰¹æ€§

### 1. è°ƒè¯•æ¨¡å¼è®¾è®¡

#### 1.1 åç«¯è°ƒè¯•æ¨¡å¼

**é…ç½®æ–¹å¼**:
```yaml
# application-dev.yml
svt:
  security:
    aes:
      enabled: true     # å¯ç”¨AESåŠ å¯†
      debug: true       # è°ƒè¯•æ¨¡å¼ï¼šè¿”å›æ˜æ–‡å“åº”
```

**å®ç°é€»è¾‘**:
```java
// AESCryptoFilter.java
private void processResponse(HttpServletRequest request, 
                           HttpServletResponse response, 
                           AESResponseWrapper responseWrapper) {
    // ğŸ”§ è°ƒè¯•æ¨¡å¼æ£€æŸ¥ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    if (aesConfig.isDebug()) {
        log.debug("è°ƒè¯•æ¨¡å¼å¯ç”¨ï¼Œè·³è¿‡å“åº”åŠ å¯†");
        return; // ç›´æ¥è¿”å›æ˜æ–‡å“åº”
    }
    
    // æ­£å¸¸åŠ å¯†é€»è¾‘...
}
```

**è°ƒè¯•æ¨¡å¼ç‰¹æ€§**:
- **è¯·æ±‚è§£å¯†**: ä»ç„¶æ‰§è¡Œï¼Œä¿è¯åç«¯èƒ½å¤„ç†åŠ å¯†è¯·æ±‚
- **å“åº”åŠ å¯†**: è·³è¿‡åŠ å¯†ï¼Œç›´æ¥è¿”å›æ˜æ–‡å“åº”
- **æ—¶é—´æˆ³éªŒè¯**: åªè­¦å‘Šä¸é˜»æ­¢ï¼Œä¾¿äºå¼€å‘è°ƒè¯•
- **æ—¥å¿—å¢å¼º**: è¾“å‡ºè¯¦ç»†çš„åŠ å¯†è§£å¯†è¿‡ç¨‹ä¿¡æ¯

#### 1.2 å‰ç«¯è°ƒè¯•æ”¯æŒ

**é…ç½®æ£€æµ‹**:
```typescript
// crypto.ts
if (import.meta.env.DEV) {
  console.log('AESé…ç½®çŠ¶æ€:', cryptoConfig.getSummary());
  console.log('å¯†é’¥çŠ¶æ€:', AESCryptoUtils.validateKey());
}
```

**åŠ¨æ€æ§åˆ¶**:
```typescript
// å¼€å‘ç¯å¢ƒä¸‹å¯åŠ¨æ€æ§åˆ¶
window.cryptoConfig?.enable();   // å¯ç”¨åŠ å¯†
window.cryptoConfig?.disable();  // ç¦ç”¨åŠ å¯†
```

### 2. è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåºè®¾è®¡

#### 2.1 åç«¯è¿‡æ»¤å™¨é“¾

```java
// æ‰§è¡Œé¡ºåºï¼ˆ@Orderæ³¨è§£æ§åˆ¶ï¼‰
HTTPè¯·æ±‚ 
â†’ AESCryptoFilter(@Order(10))        // æœ€é«˜ä¼˜å…ˆçº§ï¼Œé¦–å…ˆè§£å¯†
â†’ RequestWrapperFilter(@Order(50))   // è¯·æ±‚åŒ…è£…
â†’ JwtAuthenticationFilter(@Order(70)) // JWTè®¤è¯
â†’ ä¸šåŠ¡Controller
```

**è®¾è®¡åŸç†**:
- **AESCryptoFilterä¼˜å…ˆçº§æœ€é«˜**: ç¡®ä¿è¯·æ±‚åœ¨ä»»ä½•å…¶ä»–å¤„ç†ä¹‹å‰è¢«è§£å¯†
- **RequestWrapperFilteræ¬¡ä¹‹**: æä¾›è¯·æ±‚ä½“çš„å¤šæ¬¡è¯»å–èƒ½åŠ›
- **JwtAuthenticationFilteræœ€å**: åœ¨æ˜æ–‡è¯·æ±‚ä¸Šè¿›è¡Œè®¤è¯

#### 2.2 å…³é”®å®ç°

```java
@Component
@Order(10) // ç¡®ä¿åœ¨å…¶ä»–è¿‡æ»¤å™¨ä¹‹å‰æ‰§è¡Œ
public class AESCryptoFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        // 1. å¤„ç†è¯·æ±‚ï¼ˆè§£å¯†ï¼‰
        ServletRequest processedRequest = processRequest(httpRequest);
        
        // 2. åˆ›å»ºå“åº”åŒ…è£…å™¨
        AESResponseWrapper responseWrapper = new AESResponseWrapper(httpResponse);
        
        // 3. ç»§ç»­è¿‡æ»¤å™¨é“¾
        chain.doFilter(processedRequest, responseWrapper);
        
        // 4. å¤„ç†å“åº”ï¼ˆåŠ å¯†ï¼‰
        processResponse(httpRequest, httpResponse, responseWrapper);
    }
}
```

### 3. CORSé…ç½®å¯¹åŠ å¯†çš„æ”¯æŒ

#### 3.1 æš´éœ²åŠ å¯†æ ‡è¯†å¤´

```java
// WebMvcConfig.java
@Override
public void addCorsMappings(CorsRegistry registry) {
    registry.addMapping("/**")
            .allowedOriginPatterns("*")
            .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
            .allowedHeaders("*")
            .allowCredentials(true)
            .exposedHeaders("X-Encrypted", "Content-Type") // ğŸ”§ å…³é”®é…ç½®
            .maxAge(3600);
}
```

**è®¾è®¡æ„ä¹‰**:
- **X-Encryptedå¤´æš´éœ²**: å‰ç«¯èƒ½å¤Ÿæ£€æµ‹å“åº”æ˜¯å¦åŠ å¯†
- **è·¨åŸŸæ”¯æŒ**: ç¡®ä¿åŠ å¯†é€šä¿¡åœ¨è·¨åŸŸç¯å¢ƒä¸‹æ­£å¸¸å·¥ä½œ
- **Content-Typeä¿æŒ**: ç»´æŒJSONå“åº”çš„æ­£ç¡®ç±»å‹

#### 3.2 å‰ç«¯å“åº”å¤´å¤„ç†

```typescript
// request.ts - å“åº”æ‹¦æˆªå™¨
const encryptedHeader = response.headers['x-encrypted']; // axiosè‡ªåŠ¨è½¬å°å†™

if (AESCryptoUtils.isEnabled() && encryptedHeader === 'true') {
    // æ‰§è¡Œè§£å¯†é€»è¾‘
}
```

### 4. æ—¶é—´æˆ³é˜²é‡æ”¾æ”»å‡»æœºåˆ¶

#### 4.1 æ”»å‡»é˜²æŠ¤åŸç†

```mermaid
sequenceDiagram
    participant A as æ”»å‡»è€…
    participant C as å®¢æˆ·ç«¯
    participant S as æœåŠ¡å™¨
    
    C->>S: åˆæ³•è¯·æ±‚(timestamp: T1)
    A->>A: æˆªè·åŠ å¯†è¯·æ±‚
    Note over A: 10åˆ†é’Ÿåé‡æ”¾æ”»å‡»
    A->>S: é‡æ”¾è¯·æ±‚(timestamp: T1)
    S->>S: éªŒè¯æ—¶é—´æˆ³
    Note over S: |now - T1| > 10åˆ†é’Ÿ
    S->>A: æ‹’ç»è¯·æ±‚(æ—¶é—´æˆ³è¿‡æœŸ)
```

#### 4.2 åç«¯å®ç°

```java
// AESUtils.java
public String decryptFromAPI(Map<String, Object> encryptedData) throws BusinessException {
    // éªŒè¯æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
    Object timestampObj = encryptedData.get("timestamp");
    if (timestampObj instanceof Number) {
        long timestamp = ((Number) timestampObj).longValue();
        long currentTime = System.currentTimeMillis();
        long timeDiff = Math.abs(currentTime - timestamp);
        
        // æ£€æŸ¥æ—¶é—´æˆ³å®¹å·®ï¼ˆé»˜è®¤10åˆ†é’Ÿï¼‰
        if (timeDiff > aesConfig.getTimestampTolerance()) {
            log.warn("æ—¶é—´æˆ³éªŒè¯å¤±è´¥ï¼Œæ—¶é—´å·®: {}ms", timeDiff);
            // åœ¨è°ƒè¯•æ¨¡å¼ä¸‹åªè­¦å‘Šï¼Œä¸é˜»æ­¢è§£å¯†
            if (!aesConfig.isDebug()) {
                throw new BusinessException("è¯·æ±‚æ—¶é—´æˆ³è¶…å‡ºå…è®¸èŒƒå›´");
            }
        }
    }
    
    // ç»§ç»­è§£å¯†é€»è¾‘...
}
```

#### 4.3 å‰ç«¯æ—¶é—´æˆ³ç”Ÿæˆ

```typescript
// crypto.ts
static async encryptForAPI(data: any): Promise<EncryptedData> {
    const plainText = JSON.stringify(data);
    const { encryptedData, iv } = await this.encryptWithIV(plainText);
    
    return {
        encrypted: true,
        data: encryptedData,
        iv: iv,
        timestamp: Date.now(), // ğŸ”§ é˜²é‡æ”¾æ—¶é—´æˆ³
        version: '1.0'
    };
}
```

#### 4.4 é…ç½®å‚æ•°

```yaml
# åç«¯é…ç½®
svt:
  security:
    aes:
      timestamp-tolerance: 600000  # 10åˆ†é’Ÿå®¹å·®(æ¯«ç§’)
```

```typescript
// å‰ç«¯é…ç½®
const DEFAULT_CONFIG: CryptoConfig = {
    timestampTolerance: 10 * 60 * 1000, // 10åˆ†é’Ÿ
};
```

### 5. å¯†é’¥ç¼“å­˜æœºåˆ¶

#### 5.1 å‰ç«¯å¯†é’¥ç¼“å­˜

```typescript
// crypto.ts
let cachedKey: CryptoJS.lib.WordArray | null = null;
let keyExpiry: number = 0;

private static async getKey(): Promise<CryptoJS.lib.WordArray> {
    const now = Date.now();
    
    // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
    if (cachedKey && now < keyExpiry) {
        return cachedKey; // ä½¿ç”¨ç¼“å­˜çš„å¯†é’¥
    }
    
    // é‡æ–°è§£æå¯†é’¥å¹¶ç¼“å­˜
    const keyString = import.meta.env.VITE_AES_KEY;
    if (!keyString) {
        throw new Error('AESå¯†é’¥æœªé…ç½®');
    }
    
    // è§£æå¹¶ç¼“å­˜å¯†é’¥
    cachedKey = CryptoJS.enc.Utf8.parse(keyString);
    keyExpiry = now + cryptoConfig.get().keyCacheExpiry; // 1å°æ—¶åè¿‡æœŸ
    
    return cachedKey;
}
```

**ç¼“å­˜ç­–ç•¥**:
- **ç¼“å­˜æ—¶é•¿**: 1å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
- **å¤±æ•ˆæ£€æŸ¥**: æ¯æ¬¡ä½¿ç”¨å‰æ£€æŸ¥è¿‡æœŸæ—¶é—´
- **å†…å­˜å­˜å‚¨**: é¿å…é¢‘ç¹çš„ç¯å¢ƒå˜é‡è§£æ
- **å®‰å…¨æ¸…ç†**: é¡µé¢å¸è½½æ—¶æ¸…ç†ç¼“å­˜

#### 5.2 åç«¯å¯†é’¥ç®¡ç†

```java
// AESConfig.java
@ConfigurationProperties(prefix = "svt.security.aes")
public class AESConfig {
    
    private long keyCacheExpiry = 3600000L; // 1å°æ—¶
    
    // å¯†é’¥ç¼“å­˜é€»è¾‘ï¼ˆSpring Bootè‡ªåŠ¨ç®¡ç†ï¼‰
    // é…ç½®æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨åˆ·æ–°
}
```

### 6. æ•°æ®å¤§å°é™åˆ¶ä¿æŠ¤

#### 6.1 é˜²æŠ¤æœºåˆ¶

```java
// AESUtils.java
private static final int MAX_DATA_SIZE = 10 * 1024 * 1024; // 10MB

public String encrypt(String plainText, String ivString) throws BusinessException {
    // æ£€æŸ¥æ•°æ®å¤§å°
    byte[] data = plainText.getBytes(StandardCharsets.UTF_8);
    if (!aesConfig.isDataSizeValid(data.length)) {
        throw new BusinessException("æ•°æ®å¤§å°è¶…è¿‡é™åˆ¶: " + aesConfig.getMaxDataSize() + " bytes");
    }
    
    // ç»§ç»­åŠ å¯†é€»è¾‘...
}
```

```typescript
// crypto.ts
static async encrypt(plainText: string, ivString: string): Promise<string> {
    // æ£€æŸ¥æ•°æ®å¤§å°
    const dataSize = new Blob([plainText]).size;
    if (!cryptoConfig.isDataSizeValid(dataSize)) {
        const config = cryptoConfig.get();
        throw new Error(`æ•°æ®å¤§å°è¶…è¿‡é™åˆ¶: ${config.maxDataSize} bytes`);
    }
    
    // ç»§ç»­åŠ å¯†é€»è¾‘...
}
```

#### 6.2 é…ç½®ç®¡ç†

```yaml
# åç«¯é…ç½®
svt:
  security:
    aes:
      max-data-size: 10485760  # 10MB
```

```typescript
// å‰ç«¯é…ç½®
const DEFAULT_CONFIG: CryptoConfig = {
    maxDataSize: 10 * 1024 * 1024, // 10MB
};
```

### 7. è¯·æ±‚æ–¹æ³•æ™ºèƒ½è¿‡æ»¤

#### 7.1 å‰ç«¯è¯·æ±‚è¿‡æ»¤é€»è¾‘

```typescript
// request.ts
request.interceptors.request.use(async (config) => {
    if (AESCryptoUtils.isEnabled()) {
        const method = config.method?.toLowerCase() || '';
        
        // å¯¹POST/PUT/PATCHè¯·æ±‚çš„dataè¿›è¡ŒåŠ å¯†
        if (config.data && ['post', 'put', 'patch'].includes(method)) {
            const encryptedData = await AESCryptoUtils.encryptForAPI(config.data);
            config.data = encryptedData;
            config.headers['X-Encrypted'] = 'true';
        }
        // å¯¹æ‰€æœ‰APIè¯·æ±‚ï¼ˆåŒ…æ‹¬GETï¼‰è®¾ç½®åŠ å¯†å“åº”æ ‡è¯†
        else if (config.url?.startsWith('/')) {
            config.headers['X-Encrypted'] = 'true';
        }
    }
    
    return config;
});
```

#### 7.2 åç«¯è¯·æ±‚è¿‡æ»¤é€»è¾‘

```java
// AESCryptoFilter.java
private boolean isEncryptableMethod(String method) {
    return "POST".equalsIgnoreCase(method) || 
           "PUT".equalsIgnoreCase(method) || 
           "PATCH".equalsIgnoreCase(method);
}

private ServletRequest processRequest(HttpServletRequest request) {
    String encryptedHeader = request.getHeader("X-Encrypted");
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºåŠ å¯†è¯·æ±‚
    if (!"true".equalsIgnoreCase(encryptedHeader)) {
        return request;
    }

    // åªå¤„ç†POSTã€PUTã€PATCHè¯·æ±‚
    String method = request.getMethod();
    if (!isEncryptableMethod(method)) {
        return request;
    }
    
    // æ‰§è¡Œè§£å¯†é€»è¾‘...
}
```

### 8. URLè¿‡æ»¤è§„åˆ™è®¾è®¡

#### 8.1 åç«¯URLè¿‡æ»¤

```java
// AESCryptoFilter.java
private boolean shouldSkipEncryption(String uri) {
    if (uri == null) return true;
    
    // é™æ€èµ„æºè¿‡æ»¤
    String[] staticExtensions = {".js", ".css", ".html", ".htm", ".png", 
                                ".jpg", ".jpeg", ".gif", ".ico", ".svg"};
    for (String ext : staticExtensions) {
        if (uri.endsWith(ext)) return true;
    }
    
    // ç›‘æ§å’Œæ–‡æ¡£é¡µé¢è¿‡æ»¤
    String[] excludePaths = {"/druid", "/swagger", "/api-docs", "/actuator"};
    for (String path : excludePaths) {
        if (uri.contains(path)) return true;
    }
    
    return false;
}
```

#### 8.2 å‰ç«¯URLè¿‡æ»¤

```typescript
// request.ts
// å¯¹æ‰€æœ‰APIè¯·æ±‚ï¼ˆåŒ…æ‹¬GETï¼‰è®¾ç½®åŠ å¯†å“åº”æ ‡è¯†
else if (config.url?.startsWith('/')) {
    if (config.headers) {
        config.headers['X-Encrypted'] = 'true';
    }
}
```

### 9. å“åº”åŒ…è£…å™¨åŒé‡æ”¯æŒ

#### 9.1 è®¾è®¡èƒŒæ™¯

Spring Bootçš„JSONåºåˆ—åŒ–å¯èƒ½ä½¿ç”¨`OutputStream`æˆ–`Writer`ï¼Œéœ€è¦åŒæ—¶æ”¯æŒä¸¤ç§æ–¹å¼ã€‚

#### 9.2 å®ç°æ–¹æ¡ˆ

```java
// AESResponseWrapper.java
public class AESResponseWrapper extends HttpServletResponseWrapper {
    private ByteArrayOutputStream outputStream;
    private PrintWriter writer;
    private boolean usingWriter = false;
    private boolean usingOutputStream = false;
    
    @Override
    public ServletOutputStream getOutputStream() throws IOException {
        if (usingWriter) {
            throw new IllegalStateException("getWriter() has already been called");
        }
        usingOutputStream = true;
        
        if (outputStream == null) {
            outputStream = new ByteArrayOutputStream();
        }
        
        return new ServletOutputStream() {
            @Override
            public void write(int b) throws IOException {
                outputStream.write(b);
            }
            
            // å…¶ä»–æ–¹æ³•å®ç°...
        };
    }
    
    @Override
    public PrintWriter getWriter() throws IOException {
        if (usingOutputStream) {
            throw new IllegalStateException("getOutputStream() has already been called");
        }
        usingWriter = true;
        
        if (writer == null) {
            outputStream = new ByteArrayOutputStream();
            writer = new PrintWriter(new OutputStreamWriter(outputStream, getCharacterEncoding()));
        }
        
        return writer;
    }
    
    public byte[] getResponseData() throws IOException {
        if (writer != null) {
            writer.flush();
        }
        return outputStream != null ? outputStream.toByteArray() : new byte[0];
    }
}
```

### 10. å“åº”æ‹¦æˆªå™¨å˜é‡ä½œç”¨åŸŸä¿®å¤

#### 10.1 é—®é¢˜æè¿°

åŸå§‹ä»£ç ä¸­ä½¿ç”¨`const { data }`å¯¼è‡´è§£å¯†åçš„æ•°æ®æ— æ³•æ­£ç¡®ä¼ é€’ç»™åç»­çš„æˆåŠŸæ¡ä»¶æ£€æŸ¥ã€‚

#### 10.2 ä¿®å¤æ–¹æ¡ˆ

```typescript
// request.ts - ä¿®å¤å‰
request.interceptors.response.use(async (response) => {
    const { data } = response; // âŒ é—®é¢˜ï¼šconstå¯¼è‡´æ— æ³•ä¿®æ”¹
    
    if (AESCryptoUtils.isEnabled() && encryptedHeader === 'true') {
        if (isEncryptedData(data)) {
            const decryptedData = await AESCryptoUtils.decryptFromAPI(data);
            response.data = decryptedData;
            // dataä»ç„¶æ˜¯åŠ å¯†æ•°æ®ï¼Œå¯¼è‡´åç»­åˆ¤æ–­é”™è¯¯
        }
    }
    
    // æˆåŠŸå“åº”åˆ¤æ–­ä½¿ç”¨çš„æ˜¯åŠ å¯†æ•°æ®
    if (data.code === 200 || data.success === true) { // âŒ é”™è¯¯
        return response;
    }
});

// request.ts - ä¿®å¤å
request.interceptors.response.use(async (response) => {
    let { data } = response; // âœ… ä½¿ç”¨letå…è®¸ä¿®æ”¹
    
    if (AESCryptoUtils.isEnabled() && encryptedHeader === 'true') {
        if (isEncryptedData(data)) {
            const decryptedData = await AESCryptoUtils.decryptFromAPI(data);
            response.data = decryptedData;
            data = decryptedData; // âœ… å…³é”®ä¿®å¤ï¼šæ›´æ–°æœ¬åœ°å˜é‡
        }
    }
    
    // æˆåŠŸå“åº”åˆ¤æ–­ä½¿ç”¨è§£å¯†åçš„æ•°æ®
    if (data.code === 200 || data.success === true) { // âœ… æ­£ç¡®
        return response;
    }
});
```

### 11. æ™ºèƒ½é…ç½®æ£€æµ‹æœºåˆ¶

#### 11.1 å‰ç«¯æ™ºèƒ½æ£€æµ‹

```typescript
// crypto.ts
class CryptoConfigManager {
    private init(): void {
        const aesEnabled = import.meta.env.VITE_AES_ENABLED;
        
        if (aesEnabled !== undefined) {
            // æ˜¾å¼è®¾ç½®äº†VITE_AES_ENABLED
            this.config.enabled = aesEnabled === 'true';
        } else {
            // æœªè®¾ç½®æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰AESå¯†é’¥ï¼Œæœ‰å¯†é’¥åˆ™é»˜è®¤å¯ç”¨
            const hasAesKey = !!import.meta.env.VITE_AES_KEY;
            this.config.enabled = hasAesKey;
        }
        
        console.log(`AESåŠ å¯†${this.config.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`);
    }
}
```

#### 11.2 é…ç½®ä¼˜å…ˆçº§

1. **æ˜¾å¼ç¦ç”¨**: `VITE_AES_ENABLED=false` â†’ å¼ºåˆ¶ç¦ç”¨
2. **æ˜¾å¼å¯ç”¨**: `VITE_AES_ENABLED=true` â†’ å¼ºåˆ¶å¯ç”¨
3. **è‡ªåŠ¨æ£€æµ‹**: æœªè®¾ç½®æ—¶æ ¹æ®`VITE_AES_KEY`æ˜¯å¦å­˜åœ¨å†³å®š

### 12. åŠ å¯†æ•°æ®æ ¼å¼éªŒè¯

#### 12.1 æ ‡å‡†æ ¼å¼å®šä¹‰

```typescript
export interface EncryptedData {
    encrypted: boolean;    // åŠ å¯†æ ‡è¯†
    data: string;         // Base64ç¼–ç çš„å¯†æ–‡
    iv: string;           // Base64ç¼–ç çš„åˆå§‹åŒ–å‘é‡
    timestamp: number;    // æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾ï¼‰
    version: string;      // ç‰ˆæœ¬æ ‡è¯†
}
```

#### 12.2 æ ¼å¼éªŒè¯å‡½æ•°

```typescript
export function isEncryptedData(data: any): data is EncryptedData {
    return (
        typeof data === 'object' &&
        data !== null &&
        data.encrypted === true &&
        typeof data.data === 'string' &&
        typeof data.iv === 'string' &&
        typeof data.timestamp === 'number' &&
        typeof data.version === 'string'
    );
}
```

#### 12.3 åç«¯æ ¼å¼éªŒè¯

```java
// AESUtils.java
private boolean isValidEncryptedData(Map<String, Object> encryptedData) {
    if (encryptedData == null || encryptedData.isEmpty()) {
        return false;
    }
    
    // éªŒè¯å¿…éœ€å­—æ®µ
    return Boolean.TRUE.equals(encryptedData.get("encrypted")) &&
           encryptedData.get("data") instanceof String &&
           encryptedData.get("iv") instanceof String &&
           encryptedData.get("timestamp") instanceof Number &&
           encryptedData.get("version") instanceof String;
}
```

### 13. é…ç½®æ–‡ä»¶åŠ å¯†é›†æˆ

#### 13.1 Jasypté›†æˆ

```java
// JasyptConfig.java
@Configuration
@EnableEncryptableProperties
public class JasyptConfig {
    
    @Bean("jasyptStringEncryptor")
    public StringEncryptor stringEncryptor() {
        PooledPBEStringEncryptor encryptor = new PooledPBEStringEncryptor();
        SimpleStringPBEConfig config = new SimpleStringPBEConfig();
        
        config.setPassword(getEncryptorPassword());
        config.setAlgorithm("PBEWITHHMACSHA512ANDAES_256");
        config.setKeyObtentionIterations("1000");
        config.setPoolSize("1");
        config.setProviderName("SunJCE");
        config.setSaltGeneratorClassName("org.jasypt.salt.RandomSaltGenerator");
        config.setIvGeneratorClassName("org.jasypt.iv.RandomIvGenerator");
        config.setStringOutputType("base64");
        
        encryptor.setConfig(config);
        return encryptor;
    }
    
    private String getEncryptorPassword() {
        String password = System.getenv("JASYPT_ENCRYPTOR_PASSWORD");
        if (password == null) {
            throw new IllegalStateException("JASYPT_ENCRYPTOR_PASSWORD environment variable not set");
        }
        return password;
    }
}
```

#### 13.2 é…ç½®æ–‡ä»¶åŠ å¯†ç¤ºä¾‹

```yaml
# application-prod.yml
spring:
  datasource:
    password: ENC(MgtqLx7TCcVS9OlboFeo8Qi+Awm0knkLom756drzSsl/nKPXIQapluwRYA9PGJUD)
    
svt:
  security:
    aes:
      key: ENC(xvH9KqM3N8pL2rE6wT5yU7iO1qA4sD9fG2hJ6kL8mN3pQ5rT7vY0zX2cE4gI6kM8)
```

### 14. ç³»ç»Ÿå¯åŠ¨é…ç½®éªŒè¯

#### 14.1 å¯åŠ¨ç›‘å¬å™¨

```java
// SystemStartupListener.java
@Component
@Slf4j
public class SystemStartupListener {
    
    @Autowired
    private AESUtils aesUtils;
    
    @Autowired
    private AESConfig aesConfig;
    
    @EventListener(ApplicationReadyEvent.class)
    public void onApplicationReady(ApplicationReadyEvent event) {
        log.info("=== SVTç³»ç»Ÿå¯åŠ¨é…ç½®éªŒè¯ ===");
        
        // éªŒè¯AESé…ç½®
        validateAESConfiguration();
        
        // éªŒè¯æ•°æ®åº“è¿æ¥
        validateDatabaseConnection();
        
        // éªŒè¯Redisè¿æ¥
        validateRedisConnection();
        
        log.info("=== ç³»ç»Ÿå¯åŠ¨éªŒè¯å®Œæˆ ===");
    }
    
    private void validateAESConfiguration() {
        try {
            if (aesConfig.isEnabled()) {
                // éªŒè¯å¯†é’¥æœ‰æ•ˆæ€§
                boolean keyValid = aesUtils.validateKey();
                if (keyValid) {
                    log.info("âœ… AESé…ç½®éªŒè¯é€šè¿‡");
                } else {
                    log.error("âŒ AESå¯†é’¥éªŒè¯å¤±è´¥");
                }
                
                // éªŒè¯åŠ å¯†è§£å¯†åŠŸèƒ½
                String testData = "SVT-TEST-DATA";
                String iv = aesUtils.generateIV();
                String encrypted = aesUtils.encrypt(testData, iv);
                String decrypted = aesUtils.decrypt(encrypted, iv);
                
                if (testData.equals(decrypted)) {
                    log.info("âœ… AESåŠ å¯†è§£å¯†åŠŸèƒ½éªŒè¯é€šè¿‡");
                } else {
                    log.error("âŒ AESåŠ å¯†è§£å¯†åŠŸèƒ½éªŒè¯å¤±è´¥");
                }
            } else {
                log.info("â„¹ï¸ AESåŠ å¯†å·²ç¦ç”¨");
            }
        } catch (Exception e) {
            log.error("âŒ AESé…ç½®éªŒè¯å¼‚å¸¸: {}", e.getMessage());
        }
    }
}
```

### 15. é”™è¯¯å¤„ç†æœºåˆ¶

#### 15.1 åˆ†å±‚é”™è¯¯å¤„ç†

```java
// åç«¯é”™è¯¯å¤„ç†
@ControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<Result<?>> handleBusinessException(BusinessException e) {
        if (e.getMessage().contains("åŠ å¯†") || e.getMessage().contains("è§£å¯†")) {
            log.error("AESåŠ å¯†ç›¸å…³å¼‚å¸¸: {}", e.getMessage());
            return ResponseEntity.ok(Result.error("æ•°æ®å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•"));
        }
        return ResponseEntity.ok(Result.error(e.getMessage()));
    }
}
```

```typescript
// å‰ç«¯é”™è¯¯å¤„ç†
request.interceptors.response.use(
    async (response) => {
        // æˆåŠŸå¤„ç†é€»è¾‘
    },
    (error: AxiosError) => {
        if (error.message.includes('åŠ å¯†') || error.message.includes('è§£å¯†')) {
            console.error('AESåŠ å¯†ç›¸å…³é”™è¯¯:', error);
            message.error('æ•°æ®ä¼ è¾“å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
        return Promise.reject(error);
    }
);
```

#### 15.2 è°ƒè¯•æ¨¡å¼å®¹é”™

```java
// è°ƒè¯•æ¨¡å¼ä¸‹çš„å®¹é”™å¤„ç†
if (aesConfig.isDebug()) {
    try {
        // å°è¯•è§£å¯†
        String decrypted = aesUtils.decrypt(data, iv);
        return decrypted;
    } catch (Exception e) {
        log.warn("è°ƒè¯•æ¨¡å¼ï¼šè§£å¯†å¤±è´¥ï¼Œè¿”å›åŸå§‹æ•°æ®: {}", e.getMessage());
        return originalData; // è¿”å›åŸå§‹æ•°æ®ï¼Œä¸é˜»æ­¢æµç¨‹
    }
}
```

## ğŸ§ª æµ‹è¯•ä¸éªŒè¯

### 1. åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹

#### 1.1 åŠ å¯†è§£å¯†åŸºç¡€æµ‹è¯•

```java
@Test
public void testAESEncryptionDecryption() {
    String plainText = "Hello SVT System";
    String iv = aesUtils.generateIV();
    
    // æµ‹è¯•åŠ å¯†
    String encrypted = aesUtils.encrypt(plainText, iv);
    assertNotNull(encrypted);
    assertNotEquals(plainText, encrypted);
    
    // æµ‹è¯•è§£å¯†
    String decrypted = aesUtils.decrypt(encrypted, iv);
    assertEquals(plainText, decrypted);
}
```

#### 1.2 APIæ ¼å¼æµ‹è¯•

```java
@Test
public void testAPIEncryptionFormat() {
    String jsonData = "{\"username\":\"admin\",\"password\":\"123456\"}";
    
    Map<String, Object> encrypted = aesUtils.encryptForAPI(jsonData);
    
    // éªŒè¯æ ¼å¼
    assertTrue((Boolean) encrypted.get("encrypted"));
    assertNotNull(encrypted.get("data"));
    assertNotNull(encrypted.get("iv"));
    assertNotNull(encrypted.get("timestamp"));
    assertEquals("1.0", encrypted.get("version"));
    
    // æµ‹è¯•è§£å¯†
    String decrypted = aesUtils.decryptFromAPI(encrypted);
    assertEquals(jsonData, decrypted);
}
```

#### 1.3 æ—¶é—´æˆ³é˜²é‡æ”¾æµ‹è¯•

```java
@Test
public void testTimestampValidation() {
    Map<String, Object> encryptedData = new HashMap<>();
    encryptedData.put("encrypted", true);
    encryptedData.put("data", "test-data");
    encryptedData.put("iv", "test-iv");
    encryptedData.put("timestamp", System.currentTimeMillis() - 15 * 60 * 1000); // 15åˆ†é’Ÿå‰
    encryptedData.put("version", "1.0");
    
    // åº”è¯¥æŠ›å‡ºæ—¶é—´æˆ³å¼‚å¸¸
    assertThrows(BusinessException.class, () -> {
        aesUtils.decryptFromAPI(encryptedData);
    });
}
```

### 2. å‰ç«¯æµ‹è¯•

#### 2.1 é…ç½®æ£€æµ‹æµ‹è¯•

```typescript
// æµ‹è¯•æ™ºèƒ½é…ç½®æ£€æµ‹
describe('CryptoConfig', () => {
    test('should enable encryption when key is present', () => {
        // æ¨¡æ‹Ÿç¯å¢ƒå˜é‡
        import.meta.env.VITE_AES_KEY = 'test-key';
        delete import.meta.env.VITE_AES_ENABLED;
        
        const config = new CryptoConfigManager();
        expect(config.isEnabled()).toBe(true);
    });
    
    test('should disable encryption when explicitly set to false', () => {
        import.meta.env.VITE_AES_ENABLED = 'false';
        import.meta.env.VITE_AES_KEY = 'test-key';
        
        const config = new CryptoConfigManager();
        expect(config.isEnabled()).toBe(false);
    });
});
```

### 3. é›†æˆæµ‹è¯•

#### 3.1 ç«¯åˆ°ç«¯åŠ å¯†æµ‹è¯•

```bash
# æµ‹è¯•è„šæœ¬
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -H "X-Encrypted: true" \
  -d '{
    "encrypted": true,
    "data": "encrypted-login-data",
    "iv": "random-iv",
    "timestamp": 1640995200000,
    "version": "1.0"
  }'
```

## ğŸ“Š æ€§èƒ½ç›‘æ§

### 1. åŠ å¯†æ€§èƒ½æŒ‡æ ‡

```java
// æ€§èƒ½ç›‘æ§åˆ‡é¢
@Aspect
@Component
public class AESPerformanceAspect {
    
    @Around("execution(* com.seventeen.svt.common.util.AESUtils.encrypt*(..))")
    public Object monitorEncryption(ProceedingJoinPoint joinPoint) throws Throwable {
        long startTime = System.currentTimeMillis();
        
        try {
            Object result = joinPoint.proceed();
            long duration = System.currentTimeMillis() - startTime;
            
            log.debug("AESåŠ å¯†è€—æ—¶: {}ms", duration);
            return result;
        } catch (Exception e) {
            log.error("AESåŠ å¯†å¼‚å¸¸", e);
            throw e;
        }
    }
}
```

### 2. å‰ç«¯æ€§èƒ½ç›‘æ§

```typescript
// æ€§èƒ½ç›‘æ§
class PerformanceMonitor {
    static async measureEncryption<T>(operation: () => Promise<T>): Promise<T> {
        const start = performance.now();
        
        try {
            const result = await operation();
            const duration = performance.now() - start;
            
            console.debug(`åŠ å¯†æ“ä½œè€—æ—¶: ${duration.toFixed(2)}ms`);
            return result;
        } catch (error) {
            console.error('åŠ å¯†æ“ä½œå¤±è´¥:', error);
            throw error;
        }
    }
}
```

## ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—

### 1. å¸¸è§é—®é¢˜è¯Šæ–­

#### 1.1 åŠ å¯†å¤±è´¥

**ç—‡çŠ¶**: å‰ç«¯æ˜¾ç¤º"æ•°æ®åŠ å¯†å¤±è´¥"
**å¯èƒ½åŸå› **:
- AESå¯†é’¥æœªé…ç½®æˆ–æ ¼å¼é”™è¯¯
- æ•°æ®å¤§å°è¶…è¿‡10MBé™åˆ¶
- å¯†é’¥ç¼“å­˜è¿‡æœŸä½†ç¯å¢ƒå˜é‡ä¸å¯ç”¨

**æ’æŸ¥æ­¥éª¤**:
```javascript
// 1. æ£€æŸ¥å¯†é’¥é…ç½®
console.log('AESå¯†é’¥:', !!import.meta.env.VITE_AES_KEY);

// 2. éªŒè¯å¯†é’¥æ ¼å¼
AESCryptoUtils.validateKey().then(console.log);

// 3. æ£€æŸ¥æ•°æ®å¤§å°
console.log('æ•°æ®å¤§å°:', new Blob([JSON.stringify(data)]).size);
```

#### 1.2 è§£å¯†å¤±è´¥

**ç—‡çŠ¶**: åç«¯æ—¥å¿—æ˜¾ç¤º"AESè§£å¯†å¤±è´¥"
**å¯èƒ½åŸå› **:
- å‰åç«¯å¯†é’¥ä¸ä¸€è‡´
- IVæŸåæˆ–æ ¼å¼é”™è¯¯
- æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹

**æ’æŸ¥æ­¥éª¤**:
```java
// 1. éªŒè¯å¯†é’¥ä¸€è‡´æ€§
log.info("åç«¯AESå¯†é’¥æ‘˜è¦: {}", DigestUtils.md5Hex(aesConfig.getKey()));

// 2. æ£€æŸ¥æ•°æ®æ ¼å¼
log.info("åŠ å¯†æ•°æ®æ ¼å¼: {}", encryptedData);

// 3. éªŒè¯IVæ ¼å¼
byte[] iv = Base64.decode(ivString);
log.info("IVé•¿åº¦: {}", iv.length); // åº”è¯¥æ˜¯16
```

#### 1.3 CORSé—®é¢˜

**ç—‡çŠ¶**: å‰ç«¯æ— æ³•è¯»å–`X-Encrypted`å“åº”å¤´
**è§£å†³æ–¹æ¡ˆ**:
```java
// ç¡®ä¿CORSé…ç½®æ­£ç¡®
.exposedHeaders("X-Encrypted", "Content-Type")
```

### 2. æ—¥å¿—é…ç½®

```xml
<!-- log4j2-spring.xml -->
<Configuration>
    <Appenders>
        <RollingFile name="AESLog">
            <FileName>logs/aes.log</FileName>
            <FilePattern>logs/aes.%d{yyyy-MM-dd}.%i.log</FilePattern>
            <PatternLayout pattern="%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"/>
            <Policies>
                <TimeBasedTriggeringPolicy/>
                <SizeBasedTriggeringPolicy size="100MB"/>
            </Policies>
        </RollingFile>
    </Appenders>
    
    <Loggers>
        <Logger name="com.seventeen.svt.common.filter.AESCryptoFilter" level="DEBUG" additivity="false">
            <AppenderRef ref="AESLog"/>
        </Logger>
        <Logger name="com.seventeen.svt.common.util.AESUtils" level="DEBUG" additivity="false">
            <AppenderRef ref="AESLog"/>
        </Logger>
    </Loggers>
</Configuration>
```

## ğŸ“ˆ æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. æ€§èƒ½ä¼˜åŒ–

- **ç¡¬ä»¶åŠ é€Ÿ**: ä½¿ç”¨AES-NIæŒ‡ä»¤é›†
- **æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡åŠ å¯†è§£å¯†
- **å¼‚æ­¥å¤„ç†**: å¤§æ•°æ®é‡å¼‚æ­¥åŠ å¯†
- **ç¼“å­˜ä¼˜åŒ–**: æ™ºèƒ½ç¼“å­˜ç­–ç•¥

### 2. å®‰å…¨å¢å¼º

- **å¯†é’¥è½®æ¢**: è‡ªåŠ¨å¯†é’¥è½®æ¢æœºåˆ¶
- **å¤šå¯†é’¥æ”¯æŒ**: æ”¯æŒå¤šä¸ªå¯†é’¥ç‰ˆæœ¬
- **å®¡è®¡æ—¥å¿—**: å®Œæ•´çš„åŠ å¯†æ“ä½œå®¡è®¡
- **å…¥ä¾µæ£€æµ‹**: å¼‚å¸¸åŠ å¯†è¡Œä¸ºæ£€æµ‹

### 3. åŠŸèƒ½æ‰©å±•

- **å‹ç¼©æ”¯æŒ**: åŠ å¯†å‰æ•°æ®å‹ç¼©
- **ç­¾åéªŒè¯**: æ•°å­—ç­¾åé˜²ç¯¡æ”¹
- **å¤šç®—æ³•æ”¯æŒ**: æ”¯æŒå›½å¯†SM4ç®—æ³•
- **æµå¼å¤„ç†**: å¤§æ–‡ä»¶æµå¼åŠ å¯†

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### è”ç³»æ–¹å¼
- **æŠ€æœ¯è´Ÿè´£äºº**: SEVENTEEN
- **é‚®ç®±**: tech-support@svt.com
- **æ–‡æ¡£ä»“åº“**: [SVT Project Documentation]

### æ›´æ–°è®°å½•
- **v2.0** (2025-06-18): å®Œæ•´è®¾è®¡æ–‡æ¡£ï¼ŒåŒ…å«æ‰€æœ‰å®ç°ç»†èŠ‚
- **v1.0** (2025-06-17): åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºç¡€AESåŠ å¯†å®ç°

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æœ€åæ›´æ–°**: 2025-06-18 18:58:17 +08:00  
**ä¸‹æ¬¡å®¡æ ¸**: 2025-07-18 