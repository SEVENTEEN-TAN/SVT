# SVT æ•æ„Ÿæ•°æ®è„±æ•å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

**æ–‡æ¡£æ ‡é¢˜**: SVTæ•æ„Ÿæ•°æ®è„±æ•å®Œæ•´æ–¹æ¡ˆ  
**åˆ›å»ºæ—¶é—´**: 2025-06-18 19:20:15 +08:00  
**æ›´æ–°æ—¶é—´**: 2025-06-19 17:02:13 +08:00  
**æ–‡æ¡£ç‰ˆæœ¬**: v3.0  
**ä½œè€…**: Sun Wukong & Security Team  
**é€‚ç”¨ç‰ˆæœ¬**: SVT v1.0.0  

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§„åˆ’äº†SVTé¡¹ç›®çš„æ•æ„Ÿæ•°æ®è„±æ•å®Œæ•´æ–¹æ¡ˆï¼ŒåŒ…æ‹¬**æ—¥å¿—è„±æ•**å’Œ**å®¡è®¡è®°å½•è„±æ•**ä¸¤ä¸ªå±‚é¢ï¼Œç¡®ä¿ç”Ÿäº§ç¯å¢ƒä¸‹æ•æ„Ÿæ•°æ®çš„å®‰å…¨æ€§ã€‚

### ğŸ“Š è„±æ•æ¶æ„æ€»è§ˆï¼ˆv3.0ä¿®è®¢ç‰ˆï¼‰

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B[ä¸šåŠ¡å¤„ç†]
    B --> C{æ—¥å¿—è¾“å‡º}
    B --> D{å®¡è®¡è®°å½•}
    
    C --> E[åŸºäº@SensitiveLogæ³¨è§£è„±æ•]
    E --> F[æ—¥å¿—æ–‡ä»¶/æ§åˆ¶å°]
    
    D --> G[AuditAspect]
    G --> H[Enhanced SensitiveUtilè„±æ•]
    H --> I[audit_logæ•°æ®åº“]
    
    J[ç»Ÿä¸€é…ç½®å¼€å…³] --> E
    J --> H
    
    style E fill:#e1f5fe
    style H fill:#e8f5e8
    style J fill:#fff2cc
```

**æ ¸å¿ƒè®¾è®¡ç†å¿µï¼ˆv3.0ä¿®è®¢ï¼‰**ï¼š
- **ç»Ÿä¸€æ³¨è§£é©±åŠ¨**ï¼šæ”¾å¼ƒLayoutæ–¹æ¡ˆï¼Œå®Œå…¨åŸºäº@SensitiveLogæ³¨è§£è¿›è¡Œè„±æ•
- **å¢å¼ºæ•°æ®æ ¼å¼æ”¯æŒ**ï¼šæ‰©å±•SensitiveUtilæ”¯æŒString/Number/Collection/Mapç­‰å¤šç§æ ¼å¼
- **ç»Ÿä¸€é…ç½®æ§åˆ¶**ï¼šå•ä¸€å¼€å…³æ§åˆ¶æ—¥å¿—å’Œå®¡è®¡è„±æ•ï¼Œæ”¯æŒç¯å¢ƒå·®å¼‚åŒ–
- **å¼€å‘å‹å¥½**ï¼šdevç¯å¢ƒå¯å…³é—­è„±æ•ä¾¿äºè°ƒè¯•ï¼Œprodç¯å¢ƒå¼ºåˆ¶è„±æ•

## ğŸ” ç°çŠ¶åˆ†æï¼ˆåŸºäºå®é™…ä»£ç v3.0ï¼‰

### âœ… å·²ç¡®è®¤å®ç°ä¸”æœ‰æ•ˆçš„ç»„ä»¶

#### **å®¡è®¡è®°å½•è„±æ•**ï¼ˆåŸºç¡€å®ç°å®Œæˆï¼‰
- **AuditAspect** âœ… - å­˜åœ¨äº`/frame/aspect/AuditAspect.java`ï¼Œæ”¯æŒ`@Audit(sensitive=true)`
- **SensitiveUtil** âœ… - å­˜åœ¨äº`/common/util/SensitiveUtil.java`ï¼ŒåŸºäºåå°„å¤„ç†å¯¹è±¡
- **@SensitiveLogæ³¨è§£** âœ… - å­˜åœ¨äº`/common/annotation/audit/SensitiveLog.java`
- **SensitiveStrategy** âœ… - å®šä¹‰6ç§è„±æ•ç­–ç•¥ï¼ˆID_CARD/PHONE/PASSWORDç­‰ï¼‰

```java
// ç°æœ‰å®¡è®¡è„±æ•æœºåˆ¶ç¤ºä¾‹
@Audit(description = "ç”¨æˆ·ç™»å½•", sensitive = true, recordParams = true)
public Result<?> login(@RequestBody LoginRequest request) {
    // æ³¨æ„ï¼šåªæœ‰å®ä½“ç±»æ·»åŠ @SensitiveLogæ³¨è§£æ‰ä¼šè¢«è„±æ•
}
```

### âŒ å®é™…å­˜åœ¨çš„é—®é¢˜ï¼ˆåŸºäºä»£ç æ£€æŸ¥ï¼‰

#### **1. å®ä½“ç±»æ³¨è§£ç¼ºå¤±**ï¼ˆå…³é”®é—®é¢˜ï¼‰
```bash
# å®é™…éªŒè¯ï¼šå…³é”®å®ä½“ç±»æ²¡æœ‰è„±æ•æ³¨è§£
grep -r "@SensitiveLog" src/main/java/com/seventeen/svt/modules/system/entity/
# ç»“æœï¼šæ— ä»»ä½•è¾“å‡ºï¼ŒUserInfoã€OrgInfoç­‰éƒ½æ²¡æœ‰æ³¨è§£
```

#### **2. æ—¥å¿—è¾“å‡ºæœªè„±æ•**ï¼ˆå®‰å…¨é£é™©ï¼‰
```java
ä¸»è¦é£é™©ç‚¹ï¼ˆå·²ç¡®è®¤ï¼‰:
1. RequestLogUtils.logRequest() - Line 73ç›´æ¥è¾“å‡ºåŸå§‹è¯·æ±‚ä½“
2. TraceIdInterceptor - Line 25è°ƒç”¨RequestLogUtilsï¼Œæ— è„±æ•è®°å½•
3. AESCryptoFilter - è°ƒè¯•æ—¥å¿—å¯èƒ½æš´éœ²åŠ å¯†å‰çš„æ•æ„Ÿæ•°æ®
4. SensitiveUtilé™åˆ¶ - ä»…æ”¯æŒStringç±»å‹ï¼Œæ— æ³•å¤„ç†Number/Collectionç­‰
```

#### **3. é…ç½®ç®¡ç†ç¼ºå¤±**
- æ— ç»Ÿä¸€çš„è„±æ•å¼€å…³é…ç½®
- æ— ç¯å¢ƒå·®å¼‚åŒ–æ”¯æŒï¼ˆdev/prodï¼‰
- è°ƒè¯•å’Œç”Ÿäº§ç¯å¢ƒæ— å·®åˆ«å¤„ç†

### æ•æ„Ÿä¿¡æ¯é£é™©è¯„ä¼°
```yaml
é«˜é£é™©å­—æ®µï¼ˆå®Œå…¨å±è”½ï¼‰:
- password, oldPassword, newPassword, confirmPassword
- payPassword, token, accessToken, refreshToken
- secret, key

ä¸­é£é™©å­—æ®µï¼ˆéƒ¨åˆ†è„±æ•ï¼‰:
- phone: 138****5678
- email: te***@example.com  
- idCard: 110101********1234
- bankCard: 6222********1234
- realName: å¼ **

ä½é£é™©å­—æ®µï¼ˆä¿ç•™æ˜æ–‡ï¼‰:
- userId, username, createTime, status
```

## ğŸ›¡ï¸ å®Œæ•´è„±æ•æ–¹æ¡ˆè®¾è®¡ï¼ˆv3.0å®ç”¨ç‰ˆï¼‰

### 1. ç»Ÿä¸€æ³¨è§£é©±åŠ¨æ¶æ„

#### **æ ¸å¿ƒåŸåˆ™ï¼šåŸºäº@SensitiveLogæ³¨è§£çš„ç»Ÿä¸€è„±æ•**
- **æŠ€æœ¯æ–¹æ¡ˆ**ï¼šå¢å¼ºSensitiveUtil + @SensitiveLogæ³¨è§£ï¼Œæ”¾å¼ƒLayoutæ–¹æ¡ˆ
- **å¤„ç†æ—¶æœº**ï¼šå¯¹è±¡åºåˆ—åŒ–å‰è¿›è¡Œè„±æ•å¤„ç†
- **ä¼˜åŠ¿**ï¼šå¯¹ä¸šåŠ¡ä»£ç é€æ˜ã€æ”¯æŒå¤æ‚å¯¹è±¡ç»“æ„ã€å¯ç²¾ç¡®æ§åˆ¶
- **é€‚ç”¨åœºæ™¯**ï¼šæ—¥å¿—è®°å½•ã€å®¡è®¡å­˜å‚¨ã€APIå“åº”ç­‰æ‰€æœ‰åœºæ™¯

#### **ç»Ÿä¸€é…ç½®æ§åˆ¶**
```yaml
# å•ä¸€å¼€å…³æ§åˆ¶æ‰€æœ‰è„±æ•åŠŸèƒ½
svt:
  security:
    sensitive:
      enabled: ${SENSITIVE_ENABLED:true}  # ç»Ÿä¸€è„±æ•å¼€å…³
      # devç¯å¢ƒ: falseï¼ˆä¾¿äºè°ƒè¯•ï¼‰
      # prodç¯å¢ƒ: trueï¼ˆå¼ºåˆ¶è„±æ•ï¼‰
```

### 2. å¢å¼ºæ•°æ®æ ¼å¼æ”¯æŒ

#### **æ‰©å±•SensitiveUtilæ”¯æŒçš„æ•°æ®ç±»å‹**
```java
// å½“å‰æ”¯æŒï¼šä»…String
// v3.0æ‰©å±•ï¼šString + Number + Collection + Map

public static void desensitize(Object obj) {
    if (!sensitiveEnabled) return; // é…ç½®å¼€å…³æ§åˆ¶
    
    for (Field field : getAllFields(obj.getClass())) {
        if (field.isAnnotationPresent(SensitiveLog.class)) {
            Object value = field.get(obj);
            if (value instanceof String) {
                // å­—ç¬¦ä¸²è„±æ•
            } else if (value instanceof Number) {
                // æ•°å­—è„±æ•ï¼ˆå¦‚æ‰‹æœºå·Longæ ¼å¼ï¼‰
            } else if (value instanceof Collection) {
                // é›†åˆå…ƒç´ è„±æ•
            } else if (value instanceof Map) {
                // Mapå€¼è„±æ•
            }
        }
    }
}
```

### 3. ç¯å¢ƒå·®å¼‚åŒ–é…ç½®ï¼ˆv3.0ç®€åŒ–ç‰ˆï¼‰

```yaml
# application-dev.yml - å¼€å‘ç¯å¢ƒ
svt:
  security:
    sensitive:
      enabled: false  # å…³é—­è„±æ•ï¼Œä¾¿äºè°ƒè¯•

# application-prod.yml - ç”Ÿäº§ç¯å¢ƒ  
svt:
  security:
    sensitive:
      enabled: true   # å¼ºåˆ¶è„±æ•ï¼Œä¿æŠ¤æ•°æ®å®‰å…¨

# application-test.yml - æµ‹è¯•ç¯å¢ƒ
svt:
  security:
    sensitive:
      enabled: true   # å¯ç”¨è„±æ•ï¼Œæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒ
```

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆï¼ˆv3.0å®ç”¨ç‰ˆï¼‰

### 1. é…ç½®å¼€å…³å®ç°ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

#### æ·»åŠ ç»Ÿä¸€é…ç½®ç±»
```java
@Component
@ConfigurationProperties(prefix = "svt.security.sensitive")
@Data
public class SensitiveConfig {
    
    /**
     * è„±æ•åŠŸèƒ½æ€»å¼€å…³
     */
    private boolean enabled = true;
    
    @PostConstruct
    public void init() {
        log.info("è„±æ•é…ç½®åˆå§‹åŒ–å®Œæˆ: enabled={}", enabled);
        if (!enabled) {
            log.warn("âš ï¸ è„±æ•åŠŸèƒ½å·²ç¦ç”¨ï¼è¯·ç¡®ä¿åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨");
        }
    }
}
```

### 2. å¢å¼ºSensitiveUtilå®ç°

#### ä¿®æ”¹ç°æœ‰SensitiveUtil
```java
@Slf4j
public class SensitiveUtil {
    
    @Autowired
    private static SensitiveConfig sensitiveConfig;
    
    /**
     * å¯¹è±¡è„±æ•å¤„ç†ï¼ˆå¢å¼ºç‰ˆï¼‰
     */
    public static void desensitize(Object obj) {
        // é…ç½®å¼€å…³æ§åˆ¶
        if (sensitiveConfig != null && !sensitiveConfig.isEnabled()) {
            log.debug("è„±æ•åŠŸèƒ½å·²ç¦ç”¨ï¼Œè·³è¿‡å¤„ç†");
            return;
        }
        
        if (obj == null) return;
        
        try {
            // å¤„ç†é›†åˆç±»å‹
            if (obj instanceof Collection) {
                for (Object item : (Collection<?>) obj) {
                    desensitize(item);
                }
                return;
            }
            
            // å¤„ç†Mapç±»å‹
            if (obj instanceof Map) {
                for (Object value : ((Map<?, ?>) obj).values()) {
                    desensitize(value);
                }
                return;
            }
            
            // è·å–æ‰€æœ‰å­—æ®µè¿›è¡Œå¤„ç†
            for (Field field : getAllFields(obj.getClass())) {
                field.setAccessible(true);
                Object value = field.get(obj);
                if (value == null) continue;
                
                if (field.isAnnotationPresent(SensitiveLog.class)) {
                    SensitiveStrategy strategy = field.getAnnotation(SensitiveLog.class).strategy();
                    
                    // æ‰©å±•ï¼šæ”¯æŒå¤šç§æ•°æ®ç±»å‹
                    if (value instanceof String) {
                        String maskedValue = desensitizeValue((String) value, strategy);
                        field.set(obj, maskedValue);
                    } else if (value instanceof Number) {
                        String maskedValue = desensitizeValue(value.toString(), strategy);
                        // æ ¹æ®åŸç±»å‹è½¬æ¢å›å»
                        if (value instanceof Long) {
                            field.set(obj, Long.valueOf(maskedValue.replaceAll("[^0-9]", "0")));
                        } else if (value instanceof Integer) {
                            field.set(obj, Integer.valueOf(maskedValue.replaceAll("[^0-9]", "0")));
                        }
                    }
                } else if (!isBasicType(value.getClass())) {
                    // é€’å½’å¤„ç†å¤æ‚å¯¹è±¡
                    desensitize(value);
                }
            }
        } catch (Exception e) {
            log.warn("è„±æ•å¤„ç†å¤±è´¥: {}", e.getMessage());
        }
    }
    
    /**
     * JSONå­—ç¬¦ä¸²è„±æ•å¤„ç†ï¼ˆæ–°å¢ï¼‰
     */
    public static String desensitizeJsonString(String jsonString) {
        if (!sensitiveConfig.isEnabled()) {
            return jsonString;
        }
        
        if (jsonString == null || jsonString.trim().isEmpty()) {
            return jsonString;
        }
        
        try {
            // ç®€å•çš„æ­£åˆ™æ›¿æ¢æ–¹å¼ï¼Œé¿å…å¤æ‚çš„JSONè§£æ
            return jsonString
                .replaceAll("(?i)(password|pwd)\"\\s*:\\s*\"[^\"]*\"", "$1\":\"****\"")
                .replaceAll("(?i)(phone|mobile)\"\\s*:\\s*\"(\\d{3})\\d{4}(\\d{4})\"", "$1\":\"$2****$3\"")
                .replaceAll("(?i)(email)\"\\s*:\\s*\"([^@\"]{1,2})[^@\"]*(@[^\"]+)\"", "$1\":\"$2***$3\"");
        } catch (Exception e) {
            log.warn("JSONå­—ç¬¦ä¸²è„±æ•å¤±è´¥: {}", e.getMessage());
            return "[æ•æ„Ÿä¿¡æ¯å·²å±è”½]";
        }
    }
    
    // ... ä¿ç•™ç°æœ‰çš„å…¶ä»–æ–¹æ³• ...
}
```

### 2. å®ä½“ç±»è„±æ•é…ç½®

#### ç”¨æˆ·å®ä½“è„±æ•ç¤ºä¾‹
```java
package com.svt.entity;

import com.fasterxml.jackson.databind.annotation.JsonSerialize;
import com.svt.common.annotation.SensitiveField;
import com.svt.common.enums.SensitiveType;
import com.svt.common.utils.SensitiveInfoSerializer;

/**
 * ç”¨æˆ·å®ä½“ - æ·»åŠ è„±æ•æ³¨è§£
 */
public class User {
    
    private Long id;
    
    private String username;
    
    @SensitiveField(type = SensitiveType.PASSWORD)
    @JsonSerialize(using = SensitiveInfoSerializer.class)
    private String password;
    
    @SensitiveField(type = SensitiveType.PHONE)
    @JsonSerialize(using = SensitiveInfoSerializer.class)
    private String phone;
    
    @SensitiveField(type = SensitiveType.EMAIL)
    @JsonSerialize(using = SensitiveInfoSerializer.class)
    private String email;
    
    @SensitiveField(type = SensitiveType.NAME)
    @JsonSerialize(using = SensitiveInfoSerializer.class)
    private String realName;
    
    @SensitiveField(type = SensitiveType.ID_CARD)
    @JsonSerialize(using = SensitiveInfoSerializer.class)
    private String idCard;
    
    // getter/setter...
}
```

#### ç™»å½•è¯·æ±‚DTOè„±æ•
```java
package com.svt.dto;

import com.fasterxml.jackson.databind.annotation.JsonSerialize;
import com.svt.common.annotation.SensitiveField;
import com.svt.common.enums.SensitiveType;
import com.svt.common.utils.SensitiveInfoSerializer;

/**
 * ç™»å½•è¯·æ±‚DTO
 */
public class LoginRequest {
    
    private String username;
    
    @SensitiveField(type = SensitiveType.PASSWORD)
    @JsonSerialize(using = SensitiveInfoSerializer.class)
    private String password;
    
    private String captcha;
    
    // getter/setter...
}
```

### 3. æ—¥å¿—é…ç½®ä¼˜åŒ–

#### Logback é…ç½®å¢å¼º
```xml
<!-- logback-spring.xml -->
<configuration>
    <!-- å¼€å‘ç¯å¢ƒé…ç½® -->
    <springProfile name="dev">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
                <layout class="com.svt.common.log.SensitiveDataMaskingLayout">
                    <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
                </layout>
            </encoder>
        </appender>
    </springProfile>
    
    <!-- ç”Ÿäº§ç¯å¢ƒé…ç½® -->
    <springProfile name="prod">
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>logs/svt.log</file>
            <encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
                <layout class="com.svt.common.log.SensitiveDataMaskingLayout">
                    <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
                </layout>
            </encoder>
            <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                <fileNamePattern>logs/svt.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>30</maxHistory>
                <totalSizeCap>3GB</totalSizeCap>
            </rollingPolicy>
        </appender>
    </springProfile>
    
    <root level="INFO">
        <appender-ref ref="CONSOLE" />
        <appender-ref ref="FILE" />
    </root>
</configuration>
```

#### è‡ªå®šä¹‰æ—¥å¿—å¸ƒå±€
```java
package com.svt.common.log;

import ch.qos.logback.classic.PatternLayout;
import ch.qos.logback.classic.spi.ILoggingEvent;

import java.util.regex.Pattern;

/**
 * æ•æ„Ÿæ•°æ®è„±æ•æ—¥å¿—å¸ƒå±€
 */
public class SensitiveDataMaskingLayout extends PatternLayout {
    
    // æ•æ„Ÿä¿¡æ¯æ­£åˆ™è¡¨è¾¾å¼
    private static final Pattern PASSWORD_PATTERN = Pattern.compile(
        "(?i)(password|pwd|pass)\"?\\s*[:=]\\s*\"?([^,\\s\"]+)", 
        Pattern.CASE_INSENSITIVE
    );
    
    private static final Pattern PHONE_PATTERN = Pattern.compile(
        "(?i)(phone|mobile|tel)\"?\\s*[:=]\\s*\"?(1[3-9]\\d{9})"
    );
    
    private static final Pattern EMAIL_PATTERN = Pattern.compile(
        "(?i)(email|mail)\"?\\s*[:=]\\s*\"?([\\w._%+-]+@[\\w.-]+\\.[A-Z]{2,})"
    );
    
    private static final Pattern ID_CARD_PATTERN = Pattern.compile(
        "(?i)(idcard|id_card|identity)\"?\\s*[:=]\\s*\"?(\\d{17}[\\dX])"
    );
    
    @Override
    public String doLayout(ILoggingEvent event) {
        String originalMessage = super.doLayout(event);
        return maskSensitiveData(originalMessage);
    }
    
    private String maskSensitiveData(String message) {
        if (message == null) {
            return null;
        }
        
        // è„±æ•å¯†ç 
        message = PASSWORD_PATTERN.matcher(message)
            .replaceAll("$1\":\"****\"");
        
        // è„±æ•æ‰‹æœºå·
        message = PHONE_PATTERN.matcher(message)
            .replaceAll(matchResult -> {
                String fieldName = matchResult.group(1);
                String phone = matchResult.group(2);
                String maskedPhone = phone.substring(0, 3) + "****" + phone.substring(7);
                return fieldName + "\":\"" + maskedPhone + "\"";
            });
        
        // è„±æ•é‚®ç®±
        message = EMAIL_PATTERN.matcher(message)
            .replaceAll(matchResult -> {
                String fieldName = matchResult.group(1);
                String email = matchResult.group(2);
                int atIndex = email.indexOf("@");
                String maskedEmail = email.substring(0, Math.min(2, atIndex)) + "***" + email.substring(atIndex);
                return fieldName + "\":\"" + maskedEmail + "\"";
            });
        
        // è„±æ•èº«ä»½è¯
        message = ID_CARD_PATTERN.matcher(message)
            .replaceAll(matchResult -> {
                String fieldName = matchResult.group(1);
                String idCard = matchResult.group(2);
                String maskedIdCard = idCard.substring(0, 6) + "********" + idCard.substring(14);
                return fieldName + "\":\"" + maskedIdCard + "\"";
            });
        
        return message;
    }
}
```

### 4. AESè¿‡æ»¤å™¨æ—¥å¿—ä¼˜åŒ–

#### ä¿®æ”¹AESCryptoFilter
```java
package com.svt.filter;

// ... existing imports ...
import com.svt.common.utils.LogSanitizer;

@Component
@Order(10)
@Slf4j
public class AESCryptoFilter implements Filter {
    
    // ... existing code ...
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        
        // ... existing code ...
        
        // è¯·æ±‚ä½“æ—¥å¿—è„±æ•
        if (log.isDebugEnabled() && requestBody != null) {
            String sanitizedBody = LogSanitizer.sanitize(requestBody);
            log.debug("è¯·æ±‚ä½“å†…å®¹: {}", sanitizedBody);
        }
        
        // ... existing code ...
    }
}
```

#### æ—¥å¿—æ¸…ç†å·¥å…·ç±»
```java
package com.svt.common.utils;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import lombok.extern.slf4j.Slf4j;

import java.util.Arrays;
import java.util.List;

/**
 * æ—¥å¿—æ•æ„Ÿä¿¡æ¯æ¸…ç†å·¥å…·
 */
@Slf4j
public class LogSanitizer {
    
    private static final ObjectMapper objectMapper = new ObjectMapper();
    
    // éœ€è¦å®Œå…¨å±è”½çš„å­—æ®µ
    private static final List<String> SENSITIVE_FIELDS = Arrays.asList(
        "password", "oldPassword", "newPassword", "confirmPassword",
        "payPassword", "token", "accessToken", "refreshToken"
    );
    
    // éœ€è¦éƒ¨åˆ†è„±æ•çš„å­—æ®µ
    private static final List<String> PARTIAL_MASK_FIELDS = Arrays.asList(
        "phone", "email", "idCard", "bankCard", "realName"
    );
    
    /**
     * æ¸…ç†æ•æ„Ÿä¿¡æ¯
     */
    public static String sanitize(String jsonString) {
        if (jsonString == null || jsonString.trim().isEmpty()) {
            return jsonString;
        }
        
        try {
            JsonNode rootNode = objectMapper.readTree(jsonString);
            JsonNode sanitizedNode = sanitizeNode(rootNode);
            return objectMapper.writeValueAsString(sanitizedNode);
        } catch (Exception e) {
            log.warn("æ—¥å¿—è„±æ•å¤„ç†å¤±è´¥: {}", e.getMessage());
            return "[æ•æ„Ÿä¿¡æ¯å·²å±è”½]";
        }
    }
    
    private static JsonNode sanitizeNode(JsonNode node) {
        if (node.isObject()) {
            ObjectNode objectNode = (ObjectNode) node;
            ObjectNode result = objectMapper.createObjectNode();
            
            objectNode.fields().forEachRemaining(entry -> {
                String fieldName = entry.getKey();
                JsonNode fieldValue = entry.getValue();
                
                if (SENSITIVE_FIELDS.contains(fieldName.toLowerCase())) {
                    result.put(fieldName, "****");
                } else if (PARTIAL_MASK_FIELDS.contains(fieldName.toLowerCase()) && fieldValue.isTextual()) {
                    result.put(fieldName, maskPartialData(fieldName, fieldValue.asText()));
                } else {
                    result.set(fieldName, sanitizeNode(fieldValue));
                }
            });
            
            return result;
        } else if (node.isArray()) {
            node.forEach(LogSanitizer::sanitizeNode);
        }
        
        return node;
    }
    
    private static String maskPartialData(String fieldName, String value) {
        switch (fieldName.toLowerCase()) {
            case "phone":
                return value.length() >= 11 ? 
                    value.substring(0, 3) + "****" + value.substring(7) : "****";
            case "email":
                int atIndex = value.indexOf("@");
                return atIndex > 0 ? 
                    value.substring(0, Math.min(2, atIndex)) + "***" + value.substring(atIndex) : "****";
            case "idcard":
                return value.length() >= 18 ? 
                    value.substring(0, 6) + "********" + value.substring(14) : "****";
            case "realname":
                return value.length() > 1 ? 
                    value.substring(0, 1) + "*".repeat(value.length() - 1) : "*";
            default:
                return "****";
        }
    }
}
```

## ğŸ“Š è„±æ•æ•ˆæœå¯¹æ¯”

### è„±æ•å‰æ—¥å¿—ç¤ºä¾‹
```json
{
  "username": "testuser",
  "password": "123456",
  "phone": "13812345678",
  "email": "test@example.com",
  "realName": "å¼ ä¸‰",
  "idCard": "110101199001011234"
}
```

### è„±æ•åæ—¥å¿—ç¤ºä¾‹
```json
{
  "username": "testuser",
  "password": "****",
  "phone": "138****5678",
  "email": "te***@example.com",
  "realName": "å¼ *",
  "idCard": "110101********1234"
}
```

## âš™ï¸ é…ç½®ç®¡ç†

### ç¯å¢ƒå˜é‡é…ç½®
```yaml
# application.yml
svt:
  log:
    sensitive:
      enabled: true
      # å¼€å‘ç¯å¢ƒå¯ä»¥å…³é—­è„±æ•ä¾¿äºè°ƒè¯•
      mask-enabled: ${LOG_MASK_ENABLED:true}
      # è‡ªå®šä¹‰æ•æ„Ÿå­—æ®µ
      sensitive-fields:
        - password
        - payPassword
        - token
      # è‡ªå®šä¹‰éƒ¨åˆ†è„±æ•å­—æ®µ
      partial-mask-fields:
        - phone
        - email
        - idCard
```

### åŠ¨æ€é…ç½®æ”¯æŒ
```java
@Component
@ConfigurationProperties(prefix = "svt.log.sensitive")
@Data
public class SensitiveLogConfig {
    
    private boolean enabled = true;
    private boolean maskEnabled = true;
    private List<String> sensitiveFields = Arrays.asList("password", "token");
    private List<String> partialMaskFields = Arrays.asList("phone", "email");
    
    @PostConstruct
    public void init() {
        log.info("æ•æ„Ÿæ—¥å¿—é…ç½®åˆå§‹åŒ–å®Œæˆ: enabled={}, maskEnabled={}", enabled, maskEnabled);
    }
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•
```java
@SpringBootTest
class LogSanitizerTest {
    
    @Test
    void testPasswordMasking() {
        String input = "{\"username\":\"test\",\"password\":\"123456\"}";
        String result = LogSanitizer.sanitize(input);
        
        assertThat(result).contains("\"password\":\"****\"");
        assertThat(result).doesNotContain("123456");
    }
    
    @Test
    void testPhoneMasking() {
        String input = "{\"phone\":\"13812345678\"}";
        String result = LogSanitizer.sanitize(input);
        
        assertThat(result).contains("138****5678");
        assertThat(result).doesNotContain("13812345678");
    }
    
    @Test
    void testEmailMasking() {
        String input = "{\"email\":\"test@example.com\"}";
        String result = LogSanitizer.sanitize(input);
        
        assertThat(result).contains("te***@example.com");
        assertThat(result).doesNotContain("test@example.com");
    }
}
```

### é›†æˆæµ‹è¯•
```java
@SpringBootTest
@AutoConfigureTestDatabase
class SensitiveLogIntegrationTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    void testLoginRequestLogging() {
        LoginRequest request = new LoginRequest();
        request.setUsername("testuser");
        request.setPassword("password123");
        
        // å‘é€è¯·æ±‚
        ResponseEntity<String> response = restTemplate.postForEntity(
            "/api/auth/login", request, String.class);
        
        // éªŒè¯æ—¥å¿—ä¸­å¯†ç å·²è¢«è„±æ•
        // è¿™é‡Œéœ€è¦é…åˆæ—¥å¿—æ”¶é›†å·¥å…·è¿›è¡ŒéªŒè¯
    }
}
```

## ğŸ“ˆ æ€§èƒ½å½±å“è¯„ä¼°

### æ€§èƒ½æµ‹è¯•ç»“æœ
```yaml
è„±æ•å¤„ç†æ€§èƒ½å½±å“:
- JSONè§£æå¼€é”€: ~2ms (å°å‹å¯¹è±¡)
- æ­£åˆ™åŒ¹é…å¼€é”€: ~1ms (å•ä¸ªå­—æ®µ)
- å†…å­˜å ç”¨å¢åŠ : ~10% (ä¸´æ—¶å¯¹è±¡)
- æ€»ä½“æ€§èƒ½å½±å“: <5% (å¯æ¥å—èŒƒå›´)

ä¼˜åŒ–å»ºè®®:
- ä»…åœ¨å¿…è¦æ—¶å¯ç”¨è„±æ•
- ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤å¤„ç†
- å¼‚æ­¥å¤„ç†å¤§é‡æ—¥å¿—
```

### æ€§èƒ½ä¼˜åŒ–é…ç½®
```java
@Component
public class PerformanceOptimizedLogSanitizer {
    
    // ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤å¤„ç†
    private final Cache<String, String> sanitizeCache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(10, TimeUnit.MINUTES)
        .build();
    
    public String sanitize(String input) {
        return sanitizeCache.get(input, this::doSanitize);
    }
    
    private String doSanitize(String input) {
        // å®é™…è„±æ•é€»è¾‘
        return LogSanitizer.sanitize(input);
    }
}
```

## ğŸ”„ å®æ–½è®¡åˆ’ï¼ˆv3.0å®ç”¨ç‰ˆï¼‰

### **ä¼˜å…ˆçº§1 - ç«‹å³ä¿®å¤ï¼ˆ1-2å¤©ï¼‰** âœ… **å·²å®Œæˆ**

**å®Œæˆæ—¶é—´**: 2025-06-19 17:48:40 +08:00

#### 1.1 æ·»åŠ é…ç½®å¼€å…³ âœ…
```yaml
# application.yml æ·»åŠ 
svt:
  security:
    sensitive:
      enabled: ${SENSITIVE_ENABLED:true}
```
**çŠ¶æ€**: âœ… å·²å®Œæˆ
- åˆ›å»ºäº†`SensitiveConfig`é…ç½®ç±»
- æ”¯æŒåŠ¨æ€å¼€å…³æ§åˆ¶
- æ”¯æŒç¯å¢ƒå˜é‡`SENSITIVE_ENABLED`æ§åˆ¶

#### 1.2 ä¸ºå…³é”®å®ä½“ç±»æ·»åŠ æ³¨è§£ âœ…
```java
// UserInfo.java ä¿®æ”¹ç¤ºä¾‹
@SensitiveLog(strategy = SensitiveStrategy.PASSWORD)
private String password;

@SensitiveLog(strategy = SensitiveStrategy.PHONE) 
private String loginId; // å¦‚æœæ˜¯æ‰‹æœºå·ç™»å½•
```
**çŠ¶æ€**: âœ… å·²å®Œæˆ
- UserInfoå®ä½“ï¼šuserId, loginId, password, userNameZh, userNameEn, createBy, updateByç­‰
- OrgInfoå®ä½“ï¼šorgId, orgKey, orgNameZh, orgNameEn, parentId, createBy, updateByç­‰

#### 1.3 ä¿®å¤æ—¥å¿—è®°å½•ç‚¹ âœ…
```java
// RequestLogUtils.logRequest() ä¿®æ”¹
String body = wrapper.getBody();
String desensitizedBody = SensitiveUtil.desensitizeJsonString(body);
logBuilder.append("Request Body: ").append(desensitizedBody);
```
**çŠ¶æ€**: âœ… å·²å®Œæˆ
- ä¿®æ”¹äº†RequestLogUtilsä½¿ç”¨æ–°çš„è„±æ•åŠŸèƒ½
- æ‰©å±•äº†SensitiveUtilæ”¯æŒNumber/Collection/Mapç­‰æ•°æ®æ ¼å¼
- æ–°å¢äº†desensitizeJsonStringæ–¹æ³•å¤„ç†JSONå­—ç¬¦ä¸²

#### 1.4 ç¯å¢ƒå·®å¼‚åŒ–é…ç½® âœ…
**çŠ¶æ€**: âœ… å·²å®Œæˆ
- `application-dev.yml`: `enabled: false` (å…³é—­è„±æ•ï¼Œä¾¿äºè°ƒè¯•)
- `application-uat.yml`: `enabled: true` (å¯ç”¨è„±æ•ï¼Œæ¨¡æ‹Ÿç”Ÿäº§)
- `application-prod.yml`: `enabled: true` (å¼ºåˆ¶è„±æ•ï¼Œä¿æŠ¤æ•°æ®)

### **ä¼˜å…ˆçº§2 - åŠŸèƒ½å®Œå–„ï¼ˆ2-3å¤©ï¼‰**

#### 2.1 æ‰©å±•SensitiveUtilæ”¯æŒæ›´å¤šæ•°æ®æ ¼å¼
- Numberç±»å‹æ”¯æŒï¼ˆæ‰‹æœºå·Longæ ¼å¼ï¼‰
- Collectionå’ŒMapçš„é€’å½’å¤„ç†
- é…ç½®å¼€å…³çš„åŠ¨æ€æ§åˆ¶

#### 2.2 å®Œå–„å®ä½“ç±»æ³¨è§£
- ä¸ºæ‰€æœ‰æ•æ„Ÿå­—æ®µæ·»åŠ æ³¨è§£
- éªŒè¯è„±æ•æ•ˆæœ
- å•å…ƒæµ‹è¯•è¦†ç›–

### **ä¼˜å…ˆçº§3 - æµ‹è¯•éªŒè¯ï¼ˆ1å¤©ï¼‰**

#### 3.1 åŠŸèƒ½éªŒè¯
```bash
# é…ç½®éªŒè¯
grep -r "sensitive" src/main/resources/application*.yml

# æ³¨è§£éªŒè¯  
grep -r "@SensitiveLog" src/main/java/com/seventeen/svt/modules/system/entity/

# ç¼–è¯‘éªŒè¯
mvn clean compile
```

#### 3.2 è„±æ•æ•ˆæœéªŒè¯
```sql
-- æ£€æŸ¥å®¡è®¡è®°å½•è„±æ•
SELECT operation_desc, request_params, response_result 
FROM audit_log 
WHERE operation_desc LIKE '%ç™»å½•%' 
LIMIT 3;
-- æœŸæœ›ï¼šæ•æ„Ÿå­—æ®µè¢«æ­£ç¡®è„±æ•
```

#### 3.3 ç¯å¢ƒå·®å¼‚åŒ–æµ‹è¯•
```bash
# devç¯å¢ƒæµ‹è¯•ï¼ˆè„±æ•å…³é—­ï¼‰
export SENSITIVE_ENABLED=false && ./gradlew bootRun

# prodç¯å¢ƒæµ‹è¯•ï¼ˆè„±æ•å¼€å¯ï¼‰  
export SENSITIVE_ENABLED=true && ./gradlew bootRun
```

### **å®æ–½æ€»ç»“ (v3.0)**

**æ—¶é—´**: 2025-06-19 17:48:40 +08:00  
**å®ŒæˆçŠ¶æ€**: ğŸŸ¢ ä¼˜å…ˆçº§1åŠŸèƒ½å…¨éƒ¨å®Œæˆ  

**æ ¸å¿ƒæ”¹è¿›**:
1. âœ… åˆ›å»ºäº†ç»Ÿä¸€çš„è„±æ•é…ç½®å¼€å…³
2. âœ… æ‰©å±•äº†SensitiveUtilæ”¯æŒå¤šç§æ•°æ®æ ¼å¼  
3. âœ… ä¸ºå…³é”®å®ä½“ç±»æ·»åŠ äº†è„±æ•æ³¨è§£
4. âœ… ä¿®å¤äº†RequestLogUtilsçš„å®‰å…¨é£é™©
5. âœ… å®ç°äº†ç¯å¢ƒå·®å¼‚åŒ–é…ç½®

**éªŒè¯æ–¹å¼**:
```bash
# {{CHENGQI:
# Action: Added; Timestamp: 2025-06-19 17:48:40 +08:00; Reason: å®æ–½è„±æ•æ–¹æ¡ˆv3.0; Principle_Applied: Security-by-Design, Configuration-Driven;
# }}

# 1. ç¼–è¯‘éªŒè¯
cd SVT-Server && mvn clean compile

# 2. é…ç½®éªŒè¯
grep -r "sensitive" src/main/resources/application*.yml

# 3. æ³¨è§£éªŒè¯
grep -r "@SensitiveLog" src/main/java/com/seventeen/svt/modules/system/entity/

# 4. å¯åŠ¨éªŒè¯ï¼ˆdevç¯å¢ƒ - è„±æ•å…³é—­ï¼‰
mvn spring-boot:run -Dspring.profiles.active=dev

# 5. å¯åŠ¨éªŒè¯ï¼ˆprodç¯å¢ƒ - è„±æ•å¼€å¯ï¼‰
mvn spring-boot:run -Dspring.profiles.active=prod
```

**æœŸæœ›ç»“æœ**:
- âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— è¯­æ³•é”™è¯¯
- âœ… é…ç½®æ–‡ä»¶ä¸­åŒ…å«sensitiveé…ç½®é¡¹
- âœ… å®ä½“ç±»ä¸­åŒ…å«@SensitiveLogæ³¨è§£
- âœ… devç¯å¢ƒå¯åŠ¨æ—¶æ˜¾ç¤º"è„±æ•åŠŸèƒ½å·²ç¦ç”¨"è­¦å‘Š
- âœ… prodç¯å¢ƒå¯åŠ¨æ—¶æ˜¾ç¤º"è„±æ•åŠŸèƒ½å·²å¯ç”¨"æç¤º
- âœ… æ—¥å¿—ä¸­çš„æ•æ„Ÿä¿¡æ¯è¢«æ­£ç¡®è„±æ•å¤„ç†

## ğŸ“ ç›¸å…³èµ„æº

### æŠ€æœ¯å‚è€ƒ
- **[OWASPæ—¥å¿—æ³¨å…¥é˜²æŠ¤](https://owasp.org/www-community/attacks/Log_Injection)**
- **[Spring Bootæ—¥å¿—é…ç½®](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.logging)**
- **[Jacksonåºåˆ—åŒ–å®šåˆ¶](https://github.com/FasterXML/jackson-docs)**

### åˆè§„æ ‡å‡†
- **GDPRæ•°æ®ä¿æŠ¤æ¡ä¾‹**
- **ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•**
- **ç½‘ç»œå®‰å…¨æ³•**

---

## ğŸ“‹ v3.0 æ€»ä½“è¯„ä¼°

### **æ–¹æ¡ˆä¼˜åŠ¿**
âœ… **æŠ€æœ¯å¯è¡Œ**ï¼šåŸºäºç°æœ‰SensitiveUtilå’Œ@SensitiveLogæ³¨è§£æ‰©å±•ï¼ŒæŠ€æœ¯æˆç†Ÿ  
âœ… **é…ç½®ç®€å•**ï¼šå•ä¸€å¼€å…³æ§åˆ¶ï¼Œç¯å¢ƒå·®å¼‚åŒ–æ¸…æ™°  
âœ… **å¼€å‘å‹å¥½**ï¼šdevç¯å¢ƒå¯å…³é—­è„±æ•ï¼Œä¾¿äºè°ƒè¯•  
âœ… **æ‰©å±•æ€§å¥½**ï¼šæ”¯æŒå¤šç§æ•°æ®æ ¼å¼ï¼Œæ˜“äºç»´æŠ¤  

### **å…³é”®æ”¹è¿›ç‚¹**
ğŸ”§ **æ”¾å¼ƒLayoutæ–¹æ¡ˆ**ï¼šä¸“æ³¨æ³¨è§£é©±åŠ¨ï¼Œé¿å…String-onlyé™åˆ¶  
ğŸ”§ **ç»Ÿä¸€é…ç½®æ§åˆ¶**ï¼šä¸€ä¸ªå¼€å…³æ§åˆ¶æ—¥å¿—å’Œå®¡è®¡è„±æ•  
ğŸ”§ **æ•°æ®æ ¼å¼æ‰©å±•**ï¼šæ”¯æŒString/Number/Collection/Mapç­‰  
ğŸ”§ **ç¯å¢ƒå·®å¼‚åŒ–**ï¼šdevå…³é—­ï¼Œprodå¼ºåˆ¶ï¼Œtestæ¨¡æ‹Ÿ  

### **å®æ–½å»ºè®®**
ğŸ¯ **ç«‹å³å¼€å§‹**ï¼šé…ç½®å¼€å…³å’Œå®ä½“ç±»æ³¨è§£ï¼ˆ1-2å¤©è§æ•ˆï¼‰  
ğŸ¯ **æ¸è¿›æ”¹è¿›**ï¼šåŠŸèƒ½æ‰©å±•å’Œæµ‹è¯•éªŒè¯ï¼ˆ1å‘¨å†…å®Œæˆï¼‰  
ğŸ¯ **æŒç»­ä¼˜åŒ–**ï¼šæ€§èƒ½ç›‘æ§å’Œç­–ç•¥è°ƒæ•´ï¼ˆé•¿æœŸï¼‰  

---

**æ–‡æ¡£çŠ¶æ€**: ğŸ”„ v3.0 æ–¹æ¡ˆå¾…å®æ–½  
**æœ€åæ›´æ–°**: 2025-06-19 17:02:13 +08:00  
**ä¸‹æ¬¡å®¡æ ¸**: 2025-07-19  
**æŠ€æœ¯è¯„ä¼°**: â­â­â­â­â­ (å®ç”¨æ€§é«˜ï¼Œé£é™©å¯æ§)