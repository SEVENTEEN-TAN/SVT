# SVT 权限系统设计分析与改进建议

## Context
Project_ID: SVT Task_FileName: SVT_权限系统设计建议_2025-06-23.md 
Created_At: 2025-06-23 10:20:00 +08:00
Creator: SEVENTEEN Associated_Protocol: RIPER-5 v4.1

## 当前权限系统现状

### 权限架构
- **数据来源**: 后端 getUserDetails API 返回 menuTrees
- **存储方式**: authStore + localStorage 持久化
- **检查机制**: 页面访问时递归匹配路径权限
- **控制粒度**: 页面级权限控制

### 权限数据结构
```typescript
interface MenuTree {
  menuId: string;
  parentId: string | null;
  menuNameZh: string;
  menuNameEn: string;
  menuPath: string;        // 核心：页面访问路径
  menuIcon: string;
  menuSort: string;
  children?: MenuTree[];
}
```

## 改进建议方案

### 方案1: 增强型权限模型 (推荐)

#### 1.1 扩展权限数据结构
```typescript
interface EnhancedUser extends User {
  // 页面权限 (当前已有)
  menuTrees: MenuTree[];
  
  // 操作权限 (新增)
  permissions: {
    [menuPath: string]: {
      read: boolean;      // 查看权限
      create: boolean;    // 创建权限
      update: boolean;    // 修改权限
      delete: boolean;    // 删除权限
      export: boolean;    // 导出权限
      audit: boolean;     // 审核权限
    }
  };
  
  // 数据权限 (新增)
  dataScope: {
    type: 'ALL' | 'ORG' | 'DEPT' | 'SELF';  // 数据范围
    orgIds?: string[];   // 可访问的机构ID
    deptIds?: string[];  // 可访问的部门ID
  };
}
```

#### 1.2 权限检查工具函数
```typescript
// 页面权限检查 (当前已有)
const hasPagePermission = (path: string): boolean => { ... }

// 操作权限检查 (新增)
const hasActionPermission = (path: string, action: string): boolean => {
  const permissions = user?.permissions?.[path];
  return permissions?.[action] || false;
}

// 数据权限检查 (新增)
const hasDataPermission = (dataOrgId: string): boolean => {
  const { dataScope } = user || {};
  if (dataScope?.type === 'ALL') return true;
  if (dataScope?.type === 'ORG') return dataScope.orgIds?.includes(dataOrgId) || false;
  // ... 其他逻辑
}
```

#### 1.3 组件级权限控制
```typescript
// 权限组件包装器
const PermissionWrapper: React.FC<{
  path: string;
  action: string;
  children: React.ReactNode;
  fallback?: React.ReactNode;
}> = ({ path, action, children, fallback = null }) => {
  const hasPermission = hasActionPermission(path, action);
  return hasPermission ? <>{children}</> : <>{fallback}</>;
};

// 使用示例
<PermissionWrapper path="/system/user" action="create">
  <Button type="primary">新增用户</Button>
</PermissionWrapper>
```

### 方案2: 权限缓存与刷新机制

#### 2.1 权限变更通知
```typescript
// WebSocket 或 Server-Sent Events 监听权限变更
const usePermissionUpdates = () => {
  useEffect(() => {
    const eventSource = new EventSource('/api/sse/permission-updates');
    eventSource.onmessage = (event) => {
      const { userId, permissions } = JSON.parse(event.data);
      if (userId === currentUser.id) {
        // 刷新用户权限
        refreshUserPermissions();
      }
    };
    return () => eventSource.close();
  }, []);
};
```

#### 2.2 权限缓存策略
```typescript
// 权限缓存管理
class PermissionCache {
  private cache = new Map<string, any>();
  private ttl = 30 * 60 * 1000; // 30分钟过期
  
  set(key: string, value: any) {
    this.cache.set(key, {
      value,
      timestamp: Date.now()
    });
  }
  
  get(key: string) {
    const item = this.cache.get(key);
    if (!item) return null;
    
    if (Date.now() - item.timestamp > this.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    return item.value;
  }
}
```

### 方案3: 权限管理后台

#### 3.1 角色权限配置界面
- 可视化的权限树配置
- 批量权限分配
- 权限模板管理

#### 3.2 权限审计日志
- 记录权限变更历史
- 敏感操作权限检查日志
- 权限使用统计分析

## 实施建议

### 阶段1: 基础增强 (优先级: 高)
1. 扩展权限数据结构，支持操作权限
2. 实现 PermissionWrapper 组件
3. 在关键操作点添加权限检查

### 阶段2: 缓存优化 (优先级: 中)
1. 实现权限缓存机制
2. 添加权限变更通知
3. 优化权限检查性能

### 阶段3: 管理完善 (优先级: 低)
1. 开发权限管理后台
2. 实现权限审计功能
3. 添加权限统计分析

## 安全考虑

### 前端权限检查
- **UI隐藏**: 控制界面元素显示/隐藏
- **路由拦截**: 阻止未授权页面访问
- **组件级控制**: 细粒度功能权限

### 后端权限验证
- **API接口**: 每个接口都需要权限验证
- **数据过滤**: 根据数据权限过滤返回结果
- **操作审计**: 记录敏感操作日志

## 总结

当前权限系统已经具备了基础的页面级权限控制，架构设计合理。建议按阶段逐步增强，优先实现操作权限控制，提升用户体验和系统安全性。 