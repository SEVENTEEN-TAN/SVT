# SVT登录问题紧急诊断报告

**项目**: SVT系统  
**创建时间**: 2025-06-18 17:10:12 +08:00  
**问题状态**: 🔴 紧急 - 登录功能完全失效  
**报告人**: Sun Wukong (AI Assistant)  

## 问题概述

用户报告登录失败，显示"登录失败，请检查您的凭据"，经过深度分析发现是多个配置问题导致的系统性故障。

## 🔍 根本原因分析

### 1. 主要问题：Jasypt环境变量缺失
```
ERROR: Jasypt master password is not set. 
Please set JASYPT_ENCRYPTOR_PASSWORD environment variable.
```

**影响**: 导致所有加密配置（数据库密码、Redis密码、JWT密钥、AES密钥）无法解密，系统启动失败。

### 2. 次要问题：AES调试模式配置
- `application-dev.yml` 中 `svt.security.aes.debug: false`
- 导致AES加密失败时不会降级处理，增加调试难度

### 3. 系统状态分析
从错误日志可以看出过滤器链执行顺序：
```
AESCryptoFilter(10) → RequestWrapperFilter(50) → Spring Security Filters
```

实际登录验证失败原因：`用户名或密码错误` - 表明AES加密解密技术上是工作的，但登录验证逻辑失败。

## 🛠️ 解决方案

### 立即行动项（优先级：🔥 极高）

#### 1. 设置Jasypt主密码环境变量
```bash
# Windows PowerShell
$env:JASYPT_ENCRYPTOR_PASSWORD="你的jasypt主密码"

# Windows CMD
set JASYPT_ENCRYPTOR_PASSWORD=你的jasypt主密码

# Linux/Mac
export JASYPT_ENCRYPTOR_PASSWORD="你的jasypt主密码"
```

#### 2. 已修复：启用AES调试模式
- ✅ 已将 `svt.security.aes.debug` 改为 `true`
- 📍 文件: `SVT-Server/src/main/resources/application-dev.yml`

#### 3. 验证环境变量设置
```bash
# 检查前端AES配置
echo $VITE_AES_KEY
echo $VITE_AES_IV

# 检查后端Jasypt配置
echo $JASYPT_ENCRYPTOR_PASSWORD
```

### 📋 完整验证步骤

#### 步骤1: 环境变量设置
```bash
# 必须设置的环境变量
JASYPT_ENCRYPTOR_PASSWORD=你的jasypt主密码
VITE_AES_KEY=你的前端AES密钥(Base64格式)
VITE_AES_IV=你的前端AES初始向量(Base64格式)
```

#### 步骤2: 重启服务
1. 停止后端服务
2. 重新启动后端服务（确保环境变量生效）
3. 检查启动日志，确认无Jasypt错误

#### 步骤3: 验证登录流程
1. 打开浏览器开发者工具
2. 尝试登录
3. 检查Console日志和Network面板

### 🔧 预期日志输出

#### 后端启动成功日志
```
INFO  - Started RiskManagementApplication in X.XXX seconds
DEBUG - AES加密配置已启用，调试模式: true
INFO  - Jasypt configuration loaded successfully
```

#### 登录成功日志
```
# 前端Console
🔐 检测到需要加密的数据，正在加密...
✅ 请求数据AES加密完成
🔍 检查加密响应头: true
🔓 检测到加密响应，正在解密...
✅ 响应数据AES解密完成

# 后端日志
AES_FILTER: 处理请求: POST /api/auth/login
AES_FILTER: 检测到加密请求头: X-Encrypted=true
AES_FILTER: 请求数据解密成功
INFO  - 用户登录成功: [用户ID]
AES_FILTER: Set response headers - X-Encrypted=true
```

## 🚨 风险评估

### 高风险项
1. **数据库连接失败** - 如果Jasypt密码错误，无法连接数据库
2. **Redis连接失败** - 影响缓存和会话管理
3. **JWT签名失败** - 影响认证机制

### 缓解措施
1. 确保有数据库和Redis的备用连接方式
2. 准备明文配置作为紧急备用方案
3. 建立配置回滚机制

## 📞 紧急联系

如果问题持续存在，请提供：
1. 完整的启动日志
2. 环境变量设置截图
3. 登录尝试时的前端Console日志
4. 登录尝试时的Network请求详情

## 📝 后续改进建议

1. **配置管理优化**: 建立配置管理最佳实践
2. **监控告警**: 添加关键配置缺失的监控告警
3. **文档完善**: 创建详细的环境配置文档
4. **自动化测试**: 添加配置验证的自动化测试

---

**更新时间**: 2025-06-18 17:10:12 +08:00  
**状态**: 🔄 等待用户验证环境变量设置并重启服务 