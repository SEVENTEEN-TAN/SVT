# SVT-Server 安全设计原理

基于实际代码分析的SVT-Server安全设计原理与实现文档。

## 1. 概述

### 1.1 安全设计目标

SVT-Server的安全架构设计旨在构建一个多层防护、纵深防御的企业级安全体系：

- **机密性(Confidentiality)**: 确保敏感数据不被未授权访问
- **完整性(Integrity)**: 保证数据在传输和存储过程中不被篡改  
- **可用性(Availability)**: 确保系统服务的持续可用
- **可审计性(Auditability)**: 记录所有安全相关操作
- **不可抵赖性(Non-repudiation)**: 操作行为可追溯到具体用户

### 1.2 威胁模型

基于企业内部应用场景的威胁分析：

**高风险威胁**:
- 内部人员恶意操作
- 权限提升攻击
- 会话劫持(Token盗用)
- 敏感数据泄露

**中风险威胁**:
- 暴力破解攻击
- 重放攻击
- 配置信息泄露
- 并发登录冲突

**低风险威胁**:
- 外部网络攻击(内网部署)
- 物理访问威胁

## 2. 多层安全架构

### 2.1 安全架构分层

```
┌─────────────────────────────────────────────┐
│           第一层：网络安全                   │
│    • HTTPS/TLS传输加密                      │
│    • 防火墙/网络隔离                        │
│    • 内网部署                               │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│           第二层：传输安全                   │
│    • AES-256-CBC端到端加密                  │
│    • 数据完整性校验                         │
│    • 时间戳防重放                          │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│           第三层：认证安全                   │
│    • JWT Token认证                          │
│    • 智能黑名单机制                         │
│    • 9步安全验证流程                        │
│    • 智能续期机制                           │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│           第四层：授权安全                   │
│    • Spring Security框架                    │
│    • 方法级权限控制                         │
│    • RBAC权限模型                          │
│    • 细粒度权限验证                         │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│           第五层：数据安全                   │
│    • Argon2密码加密                         │
│    • Jasypt配置加密                         │
│    • 敏感数据脱敏                          │
│    • 安全存储策略                          │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│           第六层：审计安全                   │
│    • 操作日志记录                           │
│    • 异常行为监控                           │
│    • 安全事件追踪                          │
│    • 合规性审计                            │
└─────────────────────────────────────────────┘
```

### 2.2 纵深防御策略

每一层都独立提供安全保护，即使某一层被突破，其他层仍能提供防护。

## 3. 核心安全机制

### 3.1 JWT认证机制

#### 3.1.1 9步安全验证流程

```java
// JwtAuthenticationFilter中的验证流程
1. 系统Token验证 - 验证是否为系统颁发的合法Token
2. 黑名单检查 - 检查Token是否已被撤销
3. 缓存存在性检查 - 验证JWT缓存是否存在
4. IP地址变化检查 - 防止Token被盗用
5. Token一致性检查 - 防止并发登录
6. 活跃度过期检查 - 基于用户活跃度的会话管理
7. 智能续期机制 - 自动延长活跃用户的会话
8. 会话状态响应 - 通过响应头返回会话状态
9. 更新最后活动时间 - 记录用户活跃状态
```

#### 3.1.2 智能黑名单机制

**设计原理**:
- 只将系统颁发的合法Token加入黑名单
- 防止恶意Token造成黑名单膨胀攻击
- 黑名单大小可控，内存使用有上限

**实现细节**:
```java
// 智能Token识别
public boolean isValidSystemToken(String token) {
    // 1. 验证JWT签名
    // 2. 验证颁发者标识
    // 3. 验证必要字段完整性
    // 4. 验证Token格式规范
}
```

#### 3.1.3 智能续期机制

**续期策略**:
- 基于用户活跃度自动续期
- 不超过Token最大生命周期
- 渐进式用户提醒机制

**会话状态**:
```
NORMAL - 正常状态
WARNING - 警告状态(剩余时间<20%)
FINAL_WARNING - 最终警告(剩余时间<10%)
EXPIRED - 已过期
```

### 3.2 Spring Security配置

#### 3.2.1 核心配置

```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity(prePostEnabled = true)
public class SecurityConfig {
    // 无状态会话管理
    SessionCreationPolicy.STATELESS
    
    // 禁用CSRF(API服务)
    csrf.disable()
    
    // JWT过滤器链
    addFilterBefore(jwtAuthenticationFilter, 
        UsernamePasswordAuthenticationFilter.class)
}
```

#### 3.2.2 安全路径管理

**SecurityPathConfig**集中管理安全路径：
- 认证路径放行
- API文档路径放行
- 监控路径保护
- 静态资源处理

### 3.3 密码安全

#### 3.3.1 Argon2算法

**选择理由**:
- 抗GPU攻击的内存密集型算法
- 抗ASIC攻击的可调节参数
- 密码学竞赛获胜算法

**参数配置**:
```java
new Argon2PasswordEncoder(
    16,    // 盐长度: 128位
    32,    // 哈希长度: 256位  
    1,     // 并行度: 单线程
    4096,  // 内存: 4MB
    3      // 迭代次数: 3次
)
```

**安全强度**:
- 时间成本: 100-200ms
- 破解难度: 极高
- 彩虹表抵抗: 每个密码独立盐值

### 3.4 数据加密传输

#### 3.4.1 AES-256-CBC加密

**加密流程**:
```
客户端数据 → AES加密 → Base64编码 → HTTPS传输
          ↓
服务端解密 ← AES解密 ← Base64解码 ← 
```

**安全特性**:
- 256位密钥长度
- CBC模式+PKCS7填充
- 每次请求随机IV
- 时间戳防重放(10分钟窗口)

#### 3.4.2 加密数据格式

```json
{
  "encrypted": true,
  "data": "Base64编码的密文",
  "iv": "Base64编码的IV",
  "timestamp": 1704067200000,
  "version": "1.0"
}
```

### 3.5 权限控制

#### 3.5.1 RBAC模型

```
用户(User) → 角色(Role) → 权限(Permission) → 资源(Resource)
```

#### 3.5.2 权限粒度

1. **方法级权限**: @RequiresPermission注解
2. **API级权限**: Spring Security配置
3. **数据级权限**: 业务逻辑控制
4. **字段级权限**: DTO层控制

#### 3.5.3 权限验证实现

```java
@RequiresPermission("system:menu:add")
public Result<Void> addMenu(MenuDTO dto) {
    // 权限验证由AOP拦截器处理
    // 业务逻辑
}
```

### 3.6 审计日志

#### 3.6.1 审计范围

- **认证事件**: 登录、登出、Token刷新
- **授权事件**: 权限检查、访问拒绝  
- **数据操作**: 增删改查操作
- **系统事件**: 配置变更、异常处理
- **安全事件**: 攻击尝试、异常行为

#### 3.6.2 审计实现

```java
@Audit(module = "菜单管理", operation = "新增菜单")
public Result<Void> addMenu(@RequestBody MenuDTO dto) {
    // 审计日志由AOP拦截器自动记录
}
```

#### 3.6.3 敏感信息脱敏

```java
@SensitiveLog(fields = {"password", "mobile"})
public class LoginRequest {
    private String password; // 日志中会被脱敏
}
```

## 4. 异常处理与安全响应

### 4.1 统一异常处理

**GlobalExceptionHandler**提供统一的异常响应：

| 异常类型 | HTTP状态码 | 安全考虑 |
|---------|-----------|----------|
| 认证异常 | 401 | 不泄露具体失败原因 |
| 权限异常 | 403 | 记录非法访问尝试 |
| 参数异常 | 400 | 防止SQL注入等攻击 |
| 业务异常 | 200/400 | 自定义错误码 |
| 系统异常 | 500 | 隐藏内部错误细节 |

### 4.2 安全响应头

通过响应头传递安全状态信息：
```http
X-Session-Status: NORMAL
X-Session-Remaining: 3600
X-Session-Warning: 会话即将过期
```

## 5. 安全配置管理

### 5.1 配置加密

**Jasypt加密**:
- 加密敏感配置项
- 环境变量存储密钥
- 启动时解密

### 5.2 环境隔离

- 开发环境: 宽松的安全策略
- 测试环境: 接近生产的配置
- 生产环境: 最严格的安全控制

## 6. 安全监控与告警

### 6.1 监控指标

- 认证失败率
- 异常访问频率
- Token黑名单大小
- 加密解密性能
- 权限拒绝次数

### 6.2 告警机制

- 暴力破解检测
- 异常IP访问
- 大量权限拒绝
- 系统异常增加

## 7. 合规性与最佳实践

### 7.1 安全标准

- OWASP Top 10防护
- 等保2.0要求
- 行业安全规范

### 7.2 最佳实践

1. **最小权限原则**: 用户只获得必要的权限
2. **纵深防御**: 多层安全机制
3. **安全默认**: 默认配置即安全配置
4. **持续监控**: 实时安全状态监控
5. **定期审计**: 安全配置和日志审计

## 8. 安全加固建议

### 8.1 当前实现的优势

- 完善的JWT认证机制
- 强大的密码加密算法
- 灵活的权限控制系统
- 全面的审计日志记录
- 端到端的数据加密

### 8.2 潜在改进方向

1. **增加请求频率限制**: 防止API滥用
2. **支持多因素认证**: 提升认证安全级别
3. **增强安全监控**: 实时威胁检测
4. **支持安全事件响应**: 自动化响应机制
5. **定期安全评估**: 渗透测试和代码审计

---

## 🎯 总结

SVT-Server的安全架构采用了业界先进的安全技术和最佳实践，构建了一个多层次、全方位的安全防护体系。通过JWT智能认证、Argon2密码加密、AES数据加密、细粒度权限控制和完整审计日志等机制，有效保护了系统和数据的安全。

## 📚 相关文档

- [认证与安全实现](./Authentication-and-Security.md)
- [API加密实现](./API-Encryption-AES.md)
- [密码哈希实现](./Argon2-Password-Hashing.md)
- [审计日志实现](./Audit-Logging.md)
- [配置加密实现](./Jasypt-Configuration-Encryption.md)