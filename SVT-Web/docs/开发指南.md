# SVT-Web 开发指南

## 🚀 技术栈

- **前端框架**: React 18 + TypeScript 5.0+ + Vite 5.0+
- **UI组件库**: Ant Design 5.15+ + @ant-design/icons
- **状态管理**: Zustand 4.4+ + TanStack Query 5.0+
- **路由管理**: React Router 6.20+
- **表单处理**: React Hook Form 7.48+ + Zod 3.22+
- **HTTP客户端**: Axios 1.6+ 
- **加密处理**: crypto-js (AES加密)

## 🔧 快速开始

### 1. 初始化项目
```bash
# 创建项目
npm create vite@latest SVT-Web -- --template react-ts

# 安装核心依赖
npm install antd @ant-design/icons @ant-design/pro-components
npm install zustand @tanstack/react-query axios
npm install react-router-dom react-hook-form zod dayjs crypto-js

# 安装开发工具
npm install -D @types/node eslint prettier husky
npm install -D @typescript-eslint/eslint-plugin @typescript-eslint/parser
```

### 2. 环境配置
```env
# .env.development
VITE_API_BASE_URL=http://localhost:8080/api
VITE_APP_TITLE=SVT管理系统
VITE_APP_VERSION=1.0.0
```

### 3. 项目结构
```
src/
├── api/              # API接口层
├── components/       # 通用组件
│   ├── Schema/       # 配置化组件
│   ├── Layout/       # 布局组件
│   └── Common/       # 公共组件
├── hooks/            # 自定义Hooks
├── pages/            # 页面组件
├── schemas/          # 配置文件
├── stores/           # 状态管理
├── types/            # 类型定义
└── utils/            # 工具函数
```

## 📋 开发步骤

### 阶段一：基础架构 (2-3天)
- [x] 配置Vite构建工具和代理
- [x] 封装HTTP请求客户端
- [x] 配置Zustand状态管理
- [x] 设置Ant Design主题

### 阶段二：认证系统 (3-4天)
- [x] 登录页面组件
- [x] 登录后机构角色选择弹窗 (集成到登录页面)
- [x] JWT Token管理
- [x] AES密码加密
- [x] 路由守卫机制

### 阶段三：主布局 (2-3天)
- [x] 主布局组件
- [x] 顶部导航栏
- [x] 侧边菜单系统
- [x] 面包屑导航
- [x] Tab导航系统

### 阶段四：配置化系统 (核心)
- [ ] Schema解析器
- [ ] 动态表单渲染器
- [ ] 动态表格渲染器
- [ ] 数据源管理器

## 🎯 配置化页面系统

### 核心设计理念
通过JSON Schema配置驱动页面生成，减少重复开发工作。

### 系统架构
```
JSON Schema → 解析器 → 动态渲染器 → 页面展示
```

### 支持的页面类型
- **Info页面**: 表单信息录入和编辑
- **List页面**: 数据列表展示和操作
- **Dashboard**: 仪表板页面 (后期扩展)

## 🔧 核心技术方案

### 1. 动态数据源管理

```typescript
// DataSourceManager - 智能数据源管理
interface DataSourceConfig {
  type: 'api' | 'static';
  url?: string;
  method?: 'GET' | 'POST';
  responseMapping?: {
    labelField: string;
    valueField: string;
    dataPath?: string;
  };
  cache?: {
    enabled: boolean;
    duration: number;
  };
  dependencies?: {
    watch: string[];
    url?: string;
  };
}
```

### 2. 智能字段联动

```json
{
  "key": "departmentId",
  "label": "部门",
  "type": "select",
  "dataSource": {
    "type": "api",
    "url": "/api/departments/options",
    "dependencies": {
      "watch": ["companyId"],
      "url": "/api/departments/options?companyId={companyId}"
    }
  }
}
```

### 3. 数据绑定机制

```typescript
// useSchemaPage - 统一数据管理Hook
export const useSchemaPage = ({ schemaPath, id, mode }) => {
  // 自动加载Schema配置
  // 自动处理数据绑定
  // 自动处理依赖更新
  // 自动处理保存逻辑
};
```

### 4. 使用示例

```typescript
// 页面组件只需一行代码
export const UserInfoPage = () => {
  const { id } = useParams();
  return <DynamicForm schemaPath="users/UserInfo" id={id} />;
};
```

## 🎨 支持的组件类型

### 基础组件
- `input` - 文本输入框
- `textarea` - 多行文本  
- `number` - 数字输入
- `select` - 下拉选择
- `datePicker` - 日期选择
- `upload` - 文件上传

### 高级组件
- `cascader` - 级联选择
- `treeSelect` - 树形选择
- `dateRange` - 日期范围
- `editor` - 富文本编辑器

### 扩展组件
- `custom` - 自定义组件
- 支持组件注册机制

## 📝 开发规范

### 1. 代码规范
```typescript
// 组件开发规范
interface ComponentProps {
  // 明确的属性类型定义
}

const Component: React.FC<ComponentProps> = ({ ...props }) => {
  // Hooks在顶部
  // 事件处理函数
  // 渲染逻辑
  
  return (
    // JSX
  );
};

export default Component;
```

### 2. Schema配置规范
- 使用有意义的key值
- 必填字段标明required
- 复杂逻辑优先考虑依赖关系
- 合理使用缓存机制

### 3. 性能优化
- 合理使用React.memo
- 避免不必要的重渲染
- 大数据量使用虚拟滚动
- 合理配置数据源缓存

## 🔍 调试指南

### 1. 常见问题
- **跨域问题**: 配置Vite proxy
- **数据不更新**: 检查依赖配置
- **组件不显示**: 验证Schema配置
- **性能问题**: 检查缓存策略

### 2. 开发工具
- React DevTools - 组件调试
- Network面板 - API调试
- Console - Schema验证

### 3. 安全调试 ⚠️
**重要**: 生产环境部署前必须清理所有调试信息

#### DebugManager 调试管理器
SVT项目使用统一的 `DebugManager` 进行调试信息管理，确保开发便利性和生产安全性。

**详细文档**: [DebugManager 使用指南](./Debug-Manager-Guide.md)

#### 基本使用方法
```typescript
import { DebugManager } from '@/utils/debugManager';

// 普通调试信息（开发环境可见）
DebugManager.log('组件渲染', { componentName: 'UserCard' }, {
  component: 'UserCard',
  action: 'render'
});

// 敏感调试信息（需要特殊环境变量启用）
DebugManager.logSensitive('用户详情', userDetails, {
  component: 'authStore',
  action: 'getUserDetails'
});

// 错误信息（自动脱敏）
DebugManager.error('API调用失败', error, {
  component: 'request',
  action: 'apiCall'
});

// 生产环境关键操作
DebugManager.production('用户登录成功', {
  component: 'auth',
  action: 'login'
});
```

#### 环境变量配置
```env
# .env.development
VITE_DEBUG_SENSITIVE=true          # 启用敏感调试信息

# .env.production
VITE_DEBUG_SENSITIVE=false         # 生产环境禁用敏感调试
VITE_PRODUCTION_LOGGING=true       # 生产环境启用关键日志
```

#### 禁止的调试模式
```typescript
// ❌ 禁止：直接使用console.log输出敏感信息
console.log('用户状态验证成功:', userStatus);
console.log('AES配置状态:', cryptoConfig.getSummary());

// ❌ 禁止：在生产环境暴露开发工具
window.__SVT_DEBUG__ = { authStore, cryptoUtils };

// ❌ 禁止：敏感信息使用普通log方法
DebugManager.log('用户密码', password); // 应该使用 logSensitive
```

#### 迁移现有代码
```typescript
// 旧代码 → 新代码
console.log('操作完成') → DebugManager.log('操作完成')
console.warn('警告信息') → DebugManager.warn('警告信息')
console.error('错误信息') → DebugManager.error('错误信息')

// 敏感信息特殊处理
console.log('用户信息:', user) → DebugManager.logSensitive('用户信息', user)
```

## 🌐 API调用指南 ⭐

### 1. 基础用法
**2025-06-29 重构**: 使用泛型工厂模式消除40%+重复代码

```typescript
// 使用优化后的API方法（完全向后兼容）
import { api } from '@/utils/request';

// GET请求
const users = await api.get<User[]>('/users');

// POST请求
const newUser = await api.post<User>('/users', userData);

// PUT/DELETE请求
const updatedUser = await api.put<User>('/users/123', updateData);
await api.delete('/users/123');

// 文件上传
const formData = new FormData();
formData.append('file', file);
const result = await api.upload<UploadResult>('/upload', formData);
```

### 2. 业务API服务（推荐）
```typescript
// 推荐：创建业务API服务类
class UserApiService {
  private prefix = '/api/users';

  async getUsers(params: GetUsersParams): Promise<UserListResponse> {
    return api.get<UserListResponse>(this.prefix, { params });
  }

  async getUserById(id: string): Promise<User> {
    return api.get<User>(`${this.prefix}/${id}`);
  }

  async createUser(userData: CreateUserRequest): Promise<User> {
    return api.post<User>(this.prefix, userData);
  }

  async updateUser(id: string, userData: UpdateUserRequest): Promise<User> {
    return api.put<User>(`${this.prefix}/${id}`, userData);
  }

  async deleteUser(id: string): Promise<void> {
    return api.delete<void>(`${this.prefix}/${id}`);
  }
}

// 导出单例实例
export const userApi = new UserApiService();
```

### 4. 重构优势
- 🔧 **代码重复率降低**: 40%+ → 5%
- 📊 **性能监控**: 自动记录API调用时间
- 🛡️ **统一错误处理**: 集成DebugManager
- 🎯 **类型安全**: 完整的TypeScript支持
- 📝 **详细文档**: [API重构指南](./API-Refactoring-Guide.md)

### 5. 迁移指南
```typescript
// 现有代码继续工作，无需修改
import { api } from '@/utils/request';
const data = await api.get('/endpoint');
```

## 🏪 状态管理指南 ⭐

### 1. 统一认证Hook
**2025-06-29 重构**: 职责分离，将AuthStore拆分为3个独立Store

```typescript
// 推荐：使用统一认证Hook
import { useAuth } from '@/stores/useAuth';

const MyComponent = () => {
  const { isAuthenticated, currentUser, login, logout } = useAuth();

  return <div>{isAuthenticated ? `欢迎, ${currentUser?.username}` : '请登录'}</div>;
};
```

### 2. 分离Store使用
```typescript
// 高级用法：直接使用分离的Store
import { useAuth } from '@/stores/useAuth';

const AdvancedComponent = () => {
  const { auth, user, session } = useAuth();

  // 精确控制各个Store
  const handleLogin = async () => {
    await auth.login(credentials);
    await user.refreshUserInfo();
    session.setLoginStep('completed');
  };

  return (
    <div>
      <div>认证状态: {auth.isAuthenticated}</div>
      <div>用户信息: {user.user?.username}</div>
      <div>会话状态: {session.loginStep}</div>
    </div>
  );
};
```

### 3. 单独使用Store
```typescript
// 只需要认证功能
import { useAuthStore } from '@/stores/authStore';

const LoginComponent = () => {
  const { login, logout, isAuthenticated } = useAuthStore();
  // 只处理认证逻辑
};

// 只需要用户信息
import { useUserStore } from '@/stores/userStore';

const UserProfileComponent = () => {
  const { user, updateUser } = useUserStore();
  // 只处理用户信息
};
```

### 4. 重构优势
- 🏗️ **职责分离**: AuthStore拆分为认证、用户、会话3个Store
- 📊 **代码简化**: 单Store复杂度降低70%
- 🧪 **独立测试**: 每个Store可以独立测试
- 🚀 **激进重构**: 直接替换原Store，架构更清晰
- 📝 **详细文档**: [状态管理重构指南](./State-Management-Refactoring.md)

## 🚦 部署配置

### 开发环境
```bash
npm run dev     # 启动开发服务器
```

### 生产环境  
```bash
npm run build   # 构建生产版本
npm run preview # 预览生产版本
```

## 📈 后续扩展

### 短期目标
- 完善表格高级功能 (虚拟滚动、可编辑等)
- 支持更多组件类型
- 优化性能和用户体验

### 长期目标
- Dashboard页面支持
- 报表页面支持  
- 可视化Schema配置工具
- 插件和主题系统

---

**说明**: 本指南涵盖了SVT-Web前端的核心开发内容，后续根据实际开发情况持续更新。 